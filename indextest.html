<head>
    <style>
        body {
            background: #000000bf!important;
            color: #f5f5f7!important
        }
    </style>
<script type="module">
    var e = {
        387: (e, t, a) => {
            a.d(t, {
                forceUpdate: () => S,
                getAppInstances: () => k,
                onLoad: () => C,
                onUnload: () => w,
                saveGameState: () => x
            }),
            a.r(t);
            const i = toastr;
            var o = a.n(i);
            class l {
                currentAnimation = null;
                isAnimating = !1;
                currentText = '';
                targetElement = null;
                animationSpeed = 50;
                animationType = 'typewriter';
                constructor() {
                    this.loadSettings()
                }
                loadSettings() {
                    const e = localStorage.getItem('textAnimationSpeed')
                      , t = localStorage.getItem('textAnimationType')
                      , a = localStorage.getItem('dialogueFontSize');
                    e && (this.animationSpeed = parseInt(e, 10)),
                    t && ['typewriter', 'fade', 'instant'].includes(t) && (this.animationType = t),
                    a && this.applyFontSize(parseInt(a, 10))
                }
                saveSettings() {
                    localStorage.setItem('textAnimationSpeed', this.animationSpeed.toString()),
                    localStorage.setItem('textAnimationType', this.animationType)
                }
                setAnimationSpeed(e) {
                    this.animationSpeed = Math.max(5, Math.min(500, e)),
                    localStorage.setItem('textAnimationSpeed', this.animationSpeed.toString())
                }
                setAnimationType(e) {
                    this.animationType = e,
                    localStorage.setItem('textAnimationType', e)
                }
                setFontSize(e) {
                    localStorage.setItem('dialogueFontSize', e.toString()),
                    this.applyFontSize(e)
                }
                applyFontSize(e) {
                    const t = Math.max(12, Math.min(32, e));
                    $('#dialogue-content').css('font-size', `${t}px`)
                }
                async displayText(e, t, a) {
                    this.stopCurrentAnimation(),
                    this.currentText = e,
                    this.targetElement = t,
                    this.isAnimating = !0;
                    try {
                        switch (this.animationType) {
                        case 'typewriter':
                            await this.typewriterEffect(e, t);
                            break;
                        case 'fade':
                            await this.fadeInEffect(e, t);
                            break;
                        default:
                            this.instantDisplay(e, t)
                        }
                    } catch (e) {} finally {
                        this.isAnimating = !1,
                        a && a()
                    }
                }
                async typewriterEffect(e, t) {
                    return t.empty(),
                    new Promise( (a, n) => {
                        let s = 0;
                        const i = Array.from(e);
                        let o = 0;
                        Date.now();
                        const r = Math.max(.35, Math.min(2, this.animationSpeed / 50))
                          , c = Math.min(1, this.animationSpeed / 120)
                          , l = () => {
                            if (!this.isAnimating)
                                return void n(new Error('Animation stopped'));
                            if (s >= i.length)
                                return void a();
                            const e = i[s];
                            t.append(e),
                            s++;
                            let d = this.animationSpeed;
                            Date.now();
                            if ('ã€‚' === e || 'ï¼' === e || 'ï¼Ÿ' === e || 'â€¦' === e)
                                d *= (1.8 + Math.random() * (.8 * c)) * r,
                                o = 0;
                            else if ('ï¼Œ' === e || 'ã€' === e || 'ï¼›' === e || 'ï¼š' === e)
                                d *= (1.3 + Math.random() * (.6 * c)) * r,
                                o = 0;
                            else if (' ' === e)
                                d *= (.8 + Math.random() * (.2 * c)) * Math.max(.5, r);
                            else {
                                const e = Math.random();
                                e < .08 && 0 === o ? (o = 2 + Math.floor(2 * Math.random()),
                                d *= .6) : o > 0 ? (d *= .45 + .25 * Math.random(),
                                o--) : d *= e < .2 ? (1.8 + Math.random() * (.8 * c)) * r : e < .4 ? .85 + .25 * Math.random() : (.9 + Math.random() * (.3 * c)) * r
                            }
                            this.currentAnimation = window.setTimeout(l, Math.max(d, 12))
                        }
                        ;
                        l()
                    }
                    )
                }
                async fadeInEffect(e, t) {
                    return t.empty(),
                    new Promise( (a, n) => {
                        let s = 0;
                        const i = Array.from(e)
                          , o = () => {
                            if (!this.isAnimating)
                                return void n(new Error('Animation stopped'));
                            if (s >= i.length)
                                return void a();
                            const e = i[s];
                            t.append(e),
                            s++;
                            const r = Math.max(1 * this.animationSpeed, 20);
                            this.currentAnimation = window.setTimeout(o, r)
                        }
                        ;
                        o()
                    }
                    )
                }
                instantDisplay(e, t) {
                    t.text(e).css('opacity', '1')
                }
                stopCurrentAnimation() {
                    this.isAnimating = !1,
                    this.currentAnimation && (clearTimeout(this.currentAnimation),
                    this.currentAnimation = null),
                    this.targetElement && this.currentText && this.targetElement.stop(!0, !0).text(this.currentText).css('opacity', '1')
                }
                skipAnimation() {
                    this.isAnimating && this.targetElement && this.currentText && this.stopCurrentAnimation()
                }
                isPlaying() {
                    return this.isAnimating
                }
                getSettings() {
                    const e = parseInt(localStorage.getItem('dialogueFontSize') || '16', 10);
                    return {
                        speed: this.animationSpeed,
                        type: this.animationType,
                        fontSize: e
                    }
                }
            }
            class d {
                uiController;
                dataManager;
                stage = [];
                MAX_CHARACTERS = 3;
                characterIdCounter = 0;
                imageCache = new Map;
                MAX_CACHE_SIZE = 20;
                animatingCharacters = new Set;
                currentSpeaker = null;
                constructor(e, t) {
                    this.uiController = e,
                    this.dataManager = t
                }
                normalizeCharacterName(e) {
                    return e.replace(/-/g, '').trim()
                }
                async speakCharacter(e, t) {
                    console.log('ğŸ­ è§’è‰²è¯´è¯:', {
                        name: e,
                        spriteUrl: t
                    });
                    const a = this.normalizeCharacterName(e);
                    if (this.animatingCharacters.has(a))
                        return void console.log('â­ï¸ è§’è‰²æ­£åœ¨åŠ¨ç”»ä¸­ï¼Œè·³è¿‡:', e);
                    await this.preloadImage(t);
                    const n = this.stage.findIndex(e => this.normalizeCharacterName(e.name) === a);
                    if (n >= 0) {
                        const a = this.stage[n];
                        console.log('ğŸ”„ æ›´æ–°ç°æœ‰è§’è‰²ç«‹ç»˜:', e),
                        await this.updateCharacterSprite(a, t),
                        this.highlightSpeakingCharacter(a)
                    } else
                        console.log('ğŸ‘‹ æ–°è§’è‰²å…¥åœº:', e),
                        await this.addCharacter(e, t);
                    await this.relayoutCharacters()
                }
                async preloadImage(e) {
                    if (this.imageCache.has(e))
                        return console.log('ğŸ“· ä½¿ç”¨ç¼“å­˜å›¾ç‰‡:', e),
                        this.imageCache.get(e);
                    if (this.imageCache.size >= this.MAX_CACHE_SIZE) {
                        const e = this.imageCache.keys().next().value;
                        e && (this.imageCache.delete(e),
                        console.log('ğŸ§¹ æ¸…ç†æ—§å›¾ç‰‡ç¼“å­˜:', e))
                    }
                    return new Promise(t => {
                        const a = new Image;
                        a.onload = () => {
                            console.log('âœ… å›¾ç‰‡é¢„åŠ è½½æˆåŠŸ:', e),
                            this.imageCache.set(e, a),
                            t(a)
                        }
                        ,
                        a.onerror = () => {
                            console.error('âŒ å›¾ç‰‡åŠ è½½å¤±è´¥:', e);
                            const a = new Image;
                            a.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuWbvueJh+WKoOi9veWksei0pTwvdGV4dD48L3N2Zz4=',
                            this.imageCache.set(e, a),
                            t(a)
                        }
                        ,
                        a.src = e,
                        setTimeout( () => {
                            a.complete || a.onerror?.(new Event('timeout'))
                        }
                        , 5e3)
                    }
                    )
                }
                async addCharacter(e, t) {
                    const a = this.normalizeCharacterName(e);
                    this.animatingCharacters.add(a);
                    try {
                        if (this.stage.length >= this.MAX_CHARACTERS) {
                            const e = this.stage.shift();
                            console.log('ğŸšª ç§»é™¤æœ€æ—©è§’è‰²:', e.name),
                            await this.removeCharacterFromDOM(e)
                        }
                        const a = {
                            name: e,
                            spriteUrl: t,
                            elementId: 'character-stage-' + ++this.characterIdCounter,
                            entryTime: Date.now()
                        };
                        this.stage.push(a),
                        await this.createCharacterElement(a),
                        await this.playEntryAnimation(a),
                        this.highlightSpeakingCharacter(a),
                        console.log('âœ… è§’è‰²å·²å…¥åœºï¼Œå½“å‰èˆå°:', this.stage.map(e => e.name))
                    } finally {
                        this.animatingCharacters.delete(a)
                    }
                }
                async updateCharacterSprite(e, t) {
                    if (e.spriteUrl !== t) {
                        this.animatingCharacters.add(e.name);
                        try {
                            e.spriteUrl = t;
                            const a = $(`#${e.elementId}`);
                            a.length > 0 && (a.addClass('sprite-changing'),
                            await this.sleep(100),
                            a.attr('src', t),
                            await this.sleep(50),
                            a.removeClass('sprite-changing'),
                            console.log('ğŸ”„ ç«‹ç»˜åˆ‡æ¢å®Œæˆ:', e.name))
                        } finally {
                            this.animatingCharacters.delete(e.name)
                        }
                    }
                }
                async relayoutCharacters() {
                    const e = this.stage.length;
                    console.log('ğŸ¯ é‡æ–°å¸ƒå±€è§’è‰²ï¼Œæ•°é‡:', e);
                    const t = [];
                    for (let a = 0; a < this.stage.length; a++) {
                        const n = this.stage[a]
                          , s = $(`#${n.elementId}`);
                        if (0 === s.length)
                            continue;
                        let i;
                        i = 1 === e ? 'center' : 2 === e ? 0 === a ? 'left' : 'right' : ['three-left', 'three-center', 'three-right'][a],
                        t.push(this.moveToPosition(s, i))
                    }
                    await Promise.all(t)
                }
                async createCharacterElement(e) {
                    const t = $('.character-container');
                    if (0 === t.length)
                        return void console.error('âŒ character-container å®¹å™¨ä¸å­˜åœ¨ï¼');
                    console.log('ğŸ—ï¸ åˆ›å»ºè§’è‰²å…ƒç´ :', e.name, 'å›¾ç‰‡:', e.spriteUrl);
                    const a = $(`\n      <img id="${e.elementId}"\n           class="character-sprite dynamic"\n           src="${e.spriteUrl}"\n           alt="${e.name}"\n           style="opacity: 0;" />\n    `);
                    a.addClass('entering'),
                    a.on('load', () => {
                        console.log('âœ… è§’è‰²å›¾ç‰‡åŠ è½½æˆåŠŸ:', e.spriteUrl)
                    }
                    ).on('error', () => {
                        console.error('âŒ è§’è‰²å›¾ç‰‡åŠ è½½å¤±è´¥:', e.spriteUrl)
                    }
                    );
                    const n = t.find('.character-status-tooltip');
                    n.length > 0 ? a.insertBefore(n) : t.append(a),
                    console.log('ğŸ“¦ è§’è‰²å…ƒç´ å·²æ·»åŠ åˆ°DOM:', e.elementId)
                }
                async playEntryAnimation(e) {
                    const t = $(`#${e.elementId}`);
                    0 !== t.length ? (console.log('ğŸ¬ å¼€å§‹å…¥åœºåŠ¨ç”»:', e.name),
                    t.addClass('entering'),
                    await this.sleep(300),
                    t.removeClass('entering'),
                    t.css('opacity', '1'),
                    console.log('âœ¨ å…¥åœºåŠ¨ç”»å®Œæˆ:', e.name)) : console.error('âŒ è§’è‰²å…ƒç´ ä¸å­˜åœ¨:', e.elementId)
                }
                async moveToPosition(e, t) {
                    e.removeClass('pos-left pos-center pos-right pos-three-left pos-three-center pos-three-right').addClass(`pos-${t}`),
                    await this.sleep(400)
                }
                async removeCharacterFromDOM(e) {
                    const t = $(`#${e.elementId}`);
                    t.length > 0 && (t.addClass('exiting'),
                    await this.sleep(200),
                    t.remove())
                }
                getStageInfo() {
                    return {
                        count: this.stage.length,
                        characters: this.stage.map(e => e.name)
                    }
                }
                highlightSpeakingCharacter(e) {
                    this.currentSpeaker !== e.name ? (this.currentSpeaker = e.name,
                    $('.character-sprite.dynamic').removeClass('dimmed'),
                    $('.character-sprite.dynamic').each( (t, a) => {
                        const n = $(a);
                        n.attr('id') !== e.elementId && n.addClass('dimmed')
                    }
                    ),
                    console.log('ğŸ—£ï¸ è§’è‰²å¼€å§‹è¯´è¯:', e.name)) : console.log('ğŸ—£ï¸ è§’è‰²ç»§ç»­è¯´è¯:', e.name)
                }
                clearSpeakerHighlight() {
                    this.currentSpeaker = null,
                    $('.character-sprite.dynamic').removeClass('dimmed'),
                    console.log('ğŸ—¨ï¸ å·²æ¸…é™¤æ‰€æœ‰è§’è‰²æš—åŒ–æ•ˆæœ')
                }
                async clearStage() {
                    if (0 !== this.stage.length) {
                        console.log('ğŸ§¹ æ¸…ç©ºèˆå°ï¼Œå½“å‰è§’è‰²:', this.stage.map(e => e.name));
                        for (const e of this.stage)
                            await this.removeCharacterFromDOM(e);
                        this.stage = [],
                        this.characterIdCounter = 0,
                        this.animatingCharacters.clear(),
                        console.log('âœ… èˆå°å·²æ¸…ç©º')
                    } else
                        console.log('ğŸ§¹ èˆå°å·²ä¸ºç©ºï¼Œæ— éœ€æ¸…ç†')
                }
                executeCharacterAction(e, t) {
                    console.log('ğŸ­ åœ¨èˆå°ä¸ŠæŸ¥æ‰¾è§’è‰²è¿›è¡ŒåŠ¨ä½œ:', {
                        targetCharacterName: e,
                        actionType: t
                    });
                    const a = this.normalizeCharacterName(e)
                      , n = this.stage.find(e => this.normalizeCharacterName(e.name) === a);
                    if (!n)
                        return void console.warn('âš ï¸ ç›®æ ‡è§’è‰²ä¸åœ¨èˆå°ä¸Šï¼Œæ— æ³•æ‰§è¡ŒåŠ¨ä½œ:', e);
                    const s = $(`#${n.elementId}`);
                    if (s.length)
                        if (console.log(`ğŸ­ æ‰§è¡Œ${e}çš„${t}åŠ¨ä½œ`),
                        this.animatingCharacters.has(n.elementId))
                            console.log('â³ è§’è‰²æ­£åœ¨æ‰§è¡Œå…¶ä»–åŠ¨ç”»ï¼Œè·³è¿‡æœ¬æ¬¡åŠ¨ä½œ');
                        else {
                            this.animatingCharacters.add(n.elementId);
                            try {
                                switch (t) {
                                case 'shake':
                                    this.executeShakeAction(s, n.elementId);
                                    break;
                                case 'jump_up':
                                    this.executeJumpUpAction(s, n.elementId);
                                    break;
                                case 'jump_down':
                                    this.executeJumpDownAction(s, n.elementId);
                                    break;
                                default:
                                    console.warn('âš ï¸ æœªçŸ¥çš„åŠ¨ä½œç±»å‹:', t),
                                    this.animatingCharacters.delete(n.elementId)
                                }
                            } catch (e) {
                                console.error('âŒ æ‰§è¡Œè§’è‰²åŠ¨ä½œæ—¶å‡ºé”™:', e),
                                this.animatingCharacters.delete(n.elementId)
                            }
                        }
                    else
                        console.warn('âš ï¸ è§’è‰²å…ƒç´ ä¸å­˜åœ¨:', n.elementId)
                }
                executeShakeAction(e, t) {
                    console.log('ğŸ«¨ æ‰§è¡Œæ‘‡æ™ƒåŠ¨ä½œ'),
                    e.addClass('character-shake'),
                    setTimeout( () => {
                        e.removeClass('character-shake'),
                        this.animatingCharacters.delete(t),
                        console.log('ğŸ«¨ æ‘‡æ™ƒåŠ¨ä½œå®Œæˆ')
                    }
                    , 600)
                }
                executeJumpUpAction(e, t) {
                    console.log('â¬†ï¸ æ‰§è¡Œå‘ä¸Šè·³è·ƒåŠ¨ä½œ');
                    const a = this.getAndRemoveBreathingClasses(e);
                    e.addClass('character-jump-up'),
                    setTimeout( () => {
                        e.removeClass('character-jump-up'),
                        this.restoreBreathingClasses(e, a),
                        this.animatingCharacters.delete(t),
                        console.log('â¬†ï¸ å‘ä¸Šè·³è·ƒåŠ¨ä½œå®Œæˆ')
                    }
                    , 400)
                }
                executeJumpDownAction(e, t) {
                    console.log('â¬‡ï¸ æ‰§è¡Œå‘ä¸‹è·³è·ƒåŠ¨ä½œ');
                    const a = this.getAndRemoveBreathingClasses(e);
                    e.addClass('character-jump-down'),
                    setTimeout( () => {
                        e.removeClass('character-jump-down'),
                        this.restoreBreathingClasses(e, a),
                        this.animatingCharacters.delete(t),
                        console.log('â¬‡ï¸ å‘ä¸‹è·³è·ƒåŠ¨ä½œå®Œæˆ')
                    }
                    , 400)
                }
                cleanup() {
                    console.log('ğŸ§¹ æ¸…ç†ç«‹ç»˜ç³»ç»Ÿèµ„æº'),
                    this.imageCache.clear(),
                    this.animatingCharacters.clear(),
                    $('.character-sprite.dynamic').removeClass('dimmed'),
                    this.currentSpeaker = null,
                    this.stage = [],
                    this.characterIdCounter = 0,
                    $('.character-sprite.dynamic').remove(),
                    console.log('âœ… ç«‹ç»˜ç³»ç»Ÿèµ„æºå·²æ¸…ç†')
                }
                sleep(e) {
                    return new Promise(t => setTimeout(t, e))
                }
                getAndRemoveBreathingClasses(e) {
                    const t = [];
                    return ['breathing-natural', 'breathing-sway', 'breathing-pulse', 'breathing-rhythmic'].forEach(a => {
                        e.hasClass(a) && (t.push(a),
                        e.removeClass(a))
                    }
                    ),
                    t.length > 0 && console.log('ğŸŒ¬ï¸ Pausing breathing animation:', t),
                    t
                }
                restoreBreathingClasses(e, t) {
                    t.length > 0 && (e.addClass(t.join(' ')),
                    console.log('ğŸŒ¬ï¸ Resuming breathing animation:', t))
                }
            }
            class h {
                dataManager;
                uiController;
                textAnimationManager;
                stageManager;
                dialogueHistory = [];
                currentDialogueIndex = -1;
                MAX_DIALOGUE_HISTORY = 100;
                currentBackground = null;
                nextBackground = null;
                currentCG = null;
                displayedCG = null;
                currentBGM = null;
                lastMemoirIndexRecorded = -1;
                constructor(e, t) {
                    this.dataManager = e,
                    this.uiController = t,
                    this.textAnimationManager = new l,
                    this.stageManager = new d(this.uiController,this.dataManager)
                }
                initialize() {
                    console.log('LLMRPè§£æå™¨åˆå§‹åŒ–å®Œæˆ')
                }
                async parseAndExecute(e, t={}) {
                    try {
                        const a = e.match(/<game_response>([\s\S]*?)<\/game_response>/);
                        if (!a)
                            return;
                        const n = a[1];
                        window.skipChoiceDelay = t.skipChoiceDelay || !1,
                        console.log('ğŸ¬ å¼€å§‹è§£ææ–°å‰§æƒ…ï¼Œæ¸…ç©ºèˆå°å’Œå¯¹è¯å†å²'),
                        await this.stageManager.clearStage(),
                        this.dialogueHistory = [],
                        this.currentDialogueIndex = -1,
                        this.nextBackground = null,
                        this.currentCG = null,
                        this.hideCG();
                        const s = n.split('\n').map(e => e.trim()).filter(e => e);
                        for (const e of s) {
                            const t = this.parseLine(e);
                            t && await this.executeCommand(t)
                        }
                        try {
                            const e = [];
                            for (const t of s) {
                                if (t.startsWith('[') && t.endsWith(']'))
                                    continue;
                                const a = t.split('|');
                                if (a.length < 3)
                                    continue;
                                const n = (a[0] || '').trim();
                                let s = a.slice(2).join('|').trim();
                                if (s = s.replace(/\s*\[action\|[^|]+\|[^|\]]+\]\s*/g, '').trim(),
                                !s)
                                    continue;
                                e.push({
                                    speaker: n,
                                    text: s
                                })
                            }
                            this.uiController.setCurrentMemoir(e)
                        } catch (e) {
                            console.warn('æ„å»ºå›å¿†å½•å¤±è´¥ï¼ˆå·²å¿½ç•¥ï¼‰ï¼š', e)
                        }
                        this.dialogueHistory.length > 0 && (this.currentDialogueIndex = 0,
                        await this.displayCurrentDialogue()),
                        this.preloadDialogueImages(),
                        delete window.skipChoiceDelay,
                        this.uiController.updateUI()
                    } catch (e) {
                        console.error('LLMRPè§£æå¤±è´¥:', e)
                    }
                }
                parseLine(e) {
                    const t = e.trim();
                    if (!t)
                        return null;
                    if (t.startsWith('[') && t.endsWith(']')) {
                        const e = t.slice(1, -1)
                          , a = e.split('|').map(e => e.trim());
                        return console.log('ğŸ”§ è§£ææ–¹æ‹¬å·æŒ‡ä»¤:', {
                            content: e,
                            parts: a,
                            type: a[0]
                        }),
                        {
                            type: a[0],
                            parameters: a.slice(1)
                        }
                    }
                    const a = t.indexOf('|')
                      , n = t.indexOf('|', a + 1);
                    if (-1 !== a && -1 !== n) {
                        const e = t.substring(0, a).trim()
                          , s = t.substring(a + 1, n).trim()
                          , i = t.substring(n + 1).trim()
                          , o = [e, s, i];
                        return console.log('ğŸ” æ£€æŸ¥å¯¹è¯æŒ‡ä»¤:', {
                            line: t,
                            parts: o
                        }),
                        '' === e ? (console.warn('âš ï¸ è·³è¿‡ç©ºè§’è‰²å'),
                        null) : (console.log('ğŸ­ è¯†åˆ«ä¸ºè§’è‰²å¯¹è¯:', {
                            è§’è‰²å: e,
                            ç«‹ç»˜: s,
                            å¯¹è¯: i
                        }),
                        {
                            type: 'CHARACTER_DIALOGUE',
                            parameters: o
                        })
                    }
                    return null
                }
                async executeCommand(e) {
                    switch (e.type) {
                    case 'CHARACTER_DIALOGUE':
                        await this.handleCharacterDialogue(e.parameters);
                        break;
                    case 'bg':
                        await this.handleBackgroundCommand(e.parameters[0]);
                        break;
                    case 'bgm':
                        await this.handleBGM(e.parameters[0]);
                        break;
                    case 'choice':
                        this.handleChoice(e.parameters);
                        break;
                    case 'cg':
                        this.handleCGCommand(e.parameters[0]);
                        break;
                    case 'hide_cg':
                        this.handleHideCG();
                        break;
                    default:
                        console.log('âŒ æœªçŸ¥æˆ–ä¸æ”¯æŒçš„æŒ‡ä»¤:', e.type, '| ä»…æ”¯æŒ [bg|...]ã€[bgm|...]ã€[choice|...]ã€[cg|...]ã€[hide_cg] ä¸å¯¹è¯è¡Œ è§’è‰²|ç«‹ç»˜|æ–‡æœ¬')
                    }
                }
                async handleBGM(e) {
                    if (e && e.trim())
                        try {
                            const t = this.convertBGMNameToUrl(e.trim());
                            if (console.log('ğŸµ æ’­æ”¾BGM:', e, '-> URL:', t),
                            'undefined' == typeof audioSelect)
                                return void console.warn('âš ï¸ é…’é¦†åŠ©æ‰‹éŸ³é¢‘APIä¸å¯ç”¨ï¼Œæ— æ³•æ’­æ”¾BGM');
                            await audioSelect({
                                type: 'bgm'
                            }, t),
                            this.currentBGM = e.trim(),
                            console.log('âœ… BGMæ’­æ”¾æŒ‡ä»¤å·²å‘é€:', e)
                        } catch (e) {
                            console.error('âŒ æ’­æ”¾BGMæ—¶å‡ºé”™:', e)
                        }
                    else
                        console.warn('âš ï¸ BGMåç§°ä¸ºç©ºï¼Œè·³è¿‡æ’­æ”¾')
                }
                convertBGMNameToUrl(e) {
                    return `https://pub-37188cbfafe34cf8a0ea7ca04480b329.r2.dev/${e}.mp3`
                }
                async handleBackground(e) {
                    console.log('ğŸ–¼ï¸ åˆ‡æ¢èƒŒæ™¯:', e);
                    const t = this.convertToNetworkUrl(e, 'background');
                    console.log('ğŸ”— èƒŒæ™¯URL:', t);
                    const a = $('#content-area')
                      , n = $('#background-overlay');
                    if (!this.currentBackground)
                        return console.log('ğŸ¬ è®¾ç½®åˆå§‹èƒŒæ™¯'),
                        a.css({
                            'background-image': `url(${t})`,
                            'background-size': 'cover',
                            'background-position': 'center',
                            'background-repeat': 'no-repeat'
                        }),
                        this.currentBackground = t,
                        void console.log('âœ… åˆå§‹èƒŒæ™¯å·²è®¾ç½®');
                    if (this.currentBackground !== t) {
                        console.log('ğŸ­ å¼€å§‹èƒŒæ™¯æ·¡å…¥æ·¡å‡ºåˆ‡æ¢');
                        try {
                            n.css('opacity', '0'),
                            await this.sleep(50),
                            n.css('opacity', '1'),
                            await this.sleep(500),
                            a.css({
                                'background-image': `url(${t})`,
                                'background-size': 'cover',
                                'background-position': 'center',
                                'background-repeat': 'no-repeat'
                            }),
                            await this.sleep(50),
                            n.css('opacity', '0'),
                            await this.sleep(500),
                            this.currentBackground = t,
                            console.log('âœ… èƒŒæ™¯åˆ‡æ¢å®Œæˆ')
                        } catch (e) {
                            console.error('âŒ èƒŒæ™¯åˆ‡æ¢å¤±è´¥:', e),
                            a.css({
                                'background-image': `url(${t})`,
                                'background-size': 'cover',
                                'background-position': 'center',
                                'background-repeat': 'no-repeat'
                            }),
                            n.css('opacity', '0'),
                            this.currentBackground = t
                        }
                    } else
                        console.log('ğŸ”„ èƒŒæ™¯ç›¸åŒï¼Œè·³è¿‡åˆ‡æ¢')
                }
                async handleBackgroundCommand(e) {
                    console.log('ğŸ“ å¤„ç†èƒŒæ™¯æŒ‡ä»¤:', e);
                    const t = this.convertToNetworkUrl(e, 'background');
                    console.log('ğŸ§¹ åœºæ™¯åˆ‡æ¢ï¼Œæ¸…ç†æ‰€æœ‰ç«‹ç»˜'),
                    await this.stageManager.clearStage(),
                    this.currentBackground ? (console.log('ğŸ”— åç»­èƒŒæ™¯å·²è®°å½•ï¼Œç­‰å¾…æ¨è¿›æ—¶åˆ‡æ¢:', t),
                    this.nextBackground = t) : (console.log('ğŸ¬ ç¬¬ä¸€ä¸ªèƒŒæ™¯ï¼Œç«‹å³æ˜¾ç¤º:', t),
                    await this.handleBackground(t))
                }
                sleep(e) {
                    return new Promise(t => setTimeout(t, e))
                }
                handleCharacterDialogue(e) {
                    if (e.length < 3)
                        return void console.warn('ğŸš¨ CHARACTER_DIALOGUEæŒ‡ä»¤å‚æ•°ä¸è¶³:', e);
                    const [t,a,n] = e;
                    if (!t || '' === t)
                        return void console.warn('âš ï¸ è·³è¿‡ç©ºè§’è‰²å¯¹è¯');
                    let s = n;
                    const i = s.match(/\s*\[action\|([^|]+)\|([^|\]]+)\]\s*/);
                    let o, r = null;
                    if (i) {
                        r = {
                            targetCharacter: i[1].trim(),
                            actionType: i[2].trim()
                        },
                        s = s.replace(/\s*\[action\|([^|]+)\|([^|\]]+)\]\s*/g, '').trim(),
                        console.log('ğŸ­ æ£€æµ‹åˆ°è§’è‰²åŠ¨ä½œæŒ‡ä»¤:', r)
                    }
                    console.log('ğŸ­ å¤„ç†è§’è‰²å¯¹è¯ï¼ˆè®°å½•æ¨¡å¼ï¼‰:', {
                        characterName: t,
                        spriteFileName: a,
                        dialogueText: s,
                        actionCommand: r
                    });
                    let c = !1;
                    a && '' !== a.trim() ? (o = this.convertToNetworkUrl(a, 'character'),
                    c = !0,
                    console.log('ğŸ­ æœ‰ç«‹ç»˜è§’è‰²:', t)) : console.log('ğŸ—¨ï¸ æ— ç«‹ç»˜è§’è‰²:', t),
                    this.addToDialogueHistory({
                        speaker: t,
                        text: s,
                        type: 'dialogue',
                        backgroundUrl: this.nextBackground || void 0,
                        characterName: c ? t : void 0,
                        spriteUrl: o,
                        cgUrl: this.currentCG,
                        actionCommand: r
                    }),
                    this.nextBackground = null,
                    console.log('ğŸ“ è§’è‰²å¯¹è¯å·²è®°å½•ï¼Œç­‰æ¨è¿›æ—¶æ˜¾ç¤ºç«‹ç»˜å’Œæ‰§è¡ŒåŠ¨ä½œ')
                }
                async displayCurrentDialogue() {
                    if (this.currentDialogueIndex < 0 || this.currentDialogueIndex >= this.dialogueHistory.length)
                        return;
                    const e = this.dialogueHistory[this.currentDialogueIndex];
                    console.log('ğŸ¬ æ˜¾ç¤ºå¯¹è¯:', e),
                    e.backgroundUrl && e.backgroundUrl !== this.currentBackground && (console.log('ğŸ–¼ï¸ æ¨è¿›åˆ°èƒŒæ™¯åˆ‡æ¢ç‚¹ï¼Œå¼€å§‹åˆ‡æ¢èƒŒæ™¯:', e.backgroundUrl),
                    console.log('ğŸ§¹ æ¨è¿›åˆ°èƒŒæ™¯åˆ‡æ¢ï¼Œæ¸…ç†æ‰€æœ‰ç«‹ç»˜'),
                    await this.stageManager.clearStage(),
                    await this.handleBackground(e.backgroundUrl));
                    const t = e.cgUrl ?? null;
                    t !== this.displayedCG && (t ? this.showCG(t) : this.hideCG()),
                    e.characterName && e.spriteUrl ? (console.log('ğŸ­ æ¨è¿›åˆ°è§’è‰²å¯¹è¯ï¼Œæ˜¾ç¤ºç«‹ç»˜:', e.characterName),
                    await this.stageManager.speakCharacter(e.characterName, e.spriteUrl)) : e.speaker && (console.log('ğŸ—¨ï¸ æ— ç«‹ç»˜è§’è‰²è¯´è¯ï¼Œæ¸…é™¤æš—åŒ–æ•ˆæœ:', e.speaker),
                    this.stageManager.clearSpeakerHighlight()),
                    $('#speaker-name').text(e.speaker),
                    'choice' === e.type && e.choices ? this.displayChoicesInDialogue(e.choices) : (await this.textAnimationManager.displayText(e.text, $('#dialogue-content')),
                    this.hideChoiceInput(),
                    this.currentDialogueIndex > this.lastMemoirIndexRecorded && (this.lastMemoirIndexRecorded = this.currentDialogueIndex)),
                    e.actionCommand && setTimeout( () => {
                        this.executeCharacterAction(e.actionCommand.targetCharacter, e.actionCommand.actionType)
                    }
                    , 500),
                    this.updateNavigationButtons()
                }
                displayChoicesInDialogue(e) {
                    console.log('ğŸ¯ åœ¨å¯¹è¯æ¡†ä¸­æ˜¾ç¤ºé€‰æ‹©é¡¹:', e);
                    let t = '<div class="dialogue-choices">';
                    e.forEach( (e, a) => {
                        const n = a + 1;
                        t += `\n        <div class="dialogue-choice-item" data-choice="${n}">\n          <div class="dialogue-choice-btn">\n            <span class="choice-text">${e}</span>\n            <button class="choice-quick-send-btn" data-choice="${n}" title="å¿«é€Ÿå‘é€æ­¤é€‰æ‹©">\n              <i class="fas fa-paper-plane"></i>\n            </button>\n          </div>\n        </div>\n      `
                    }
                    ),
                    t += '</div>',
                    $('#dialogue-content').html(t),
                    $('.choice-text').off('click').on('click', t => {
                        t.stopPropagation();
                        const a = $(t.currentTarget).closest('.dialogue-choice-item')
                          , n = parseInt(a.data('choice'))
                          , s = e[n - 1];
                        console.log('ğŸ’­ æ·»åŠ é€‰æ‹©åˆ°è¡ŒåŠ¨åˆ—è¡¨:', {
                            number: n,
                            text: s
                        }),
                        this.addChoiceToCommands(s)
                    }
                    ),
                    $('.choice-quick-send-btn').off('click').on('click', t => {
                        t.stopPropagation();
                        const a = parseInt($(t.currentTarget).data('choice'))
                          , n = e[a - 1];
                        console.log('ğŸš€ å¿«é€Ÿå‘é€é€‰æ‹©:', {
                            number: a,
                            text: n
                        }),
                        this.handleChoiceSelection(a - 1, n)
                    }
                    ),
                    this.showChoiceInput()
                }
                executeCharacterAction(e, t) {
                    console.log('ğŸ­ æ‰§è¡Œè§’è‰²åŠ¨ä½œ:', {
                        targetCharacter: e,
                        actionType: t
                    });
                    try {
                        this.stageManager.executeCharacterAction(e, t)
                    } catch (e) {
                        console.error('âŒ æ‰§è¡Œè§’è‰²åŠ¨ä½œå¤±è´¥:', e)
                    }
                }
                updateNavigationButtons() {
                    const e = $('#prev-btn')
                      , t = $('#next-btn');
                    this.currentDialogueIndex <= 0 ? e.prop('disabled', !0).addClass('disabled') : e.prop('disabled', !1).removeClass('disabled');
                    const a = this.dialogueHistory[this.currentDialogueIndex]
                      , n = this.currentDialogueIndex >= this.dialogueHistory.length - 1
                      , s = a && 'choice' === a.type;
                    n || s ? (t.prop('disabled', !0).addClass('disabled').removeClass('choice-ready'),
                    console.log('ğŸš« ç¦ç”¨NextæŒ‰é’®:', n ? 'å·²æ˜¯æœ€åå¯¹è¯' : 'å½“å‰æ˜¯é€‰æ‹©ç•Œé¢')) : t.prop('disabled', !1).removeClass('disabled').removeClass('choice-ready')
                }
                async navigatePrevious() {
                    return this.textAnimationManager.stopCurrentAnimation(),
                    this.currentDialogueIndex > 0 && (this.currentDialogueIndex--,
                    await this.displayCurrentDialogue(),
                    !0)
                }
                async navigateNext() {
                    if (this.textAnimationManager.isPlaying())
                        return this.textAnimationManager.skipAnimation(),
                        !0;
                    const e = this.dialogueHistory[this.currentDialogueIndex];
                    return e && 'choice' === e.type ? (console.log('ğŸš« å½“å‰æ˜¯é€‰æ‹©ç•Œé¢ï¼Œç¦æ­¢å¯¼èˆªåˆ°ä¸‹ä¸€æ¡å¯¹è¯'),
                    !1) : this.currentDialogueIndex < this.dialogueHistory.length - 1 && (this.currentDialogueIndex++,
                    await this.displayCurrentDialogue(),
                    !0)
                }
                getTextAnimationManager() {
                    return this.textAnimationManager
                }
                getCurrentBGM() {
                    return this.currentBGM
                }
                handleChoice(e) {
                    if (console.log('ğŸ¯ é€‰æ‹©é¡¹:', e),
                    $('.choice-container').remove(),
                    window.skipChoiceDelay)
                        return console.log('ğŸ”„ é‡æ–°æ¸²æŸ“æ¨¡å¼ï¼Œå°†é€‰æ‹©é¡¹æ·»åŠ åˆ°å†å²ä½†ä¸æ˜¾ç¤º'),
                        void this.addToDialogueHistory({
                            speaker: 'é€‰æ‹©',
                            text: 'è¯·é€‰æ‹©ä½ çš„å›åº”ï¼š',
                            type: 'choice',
                            choices: e
                        });
                    this.addToDialogueHistory({
                        speaker: 'é€‰æ‹©',
                        text: 'è¯·é€‰æ‹©ä½ çš„å›åº”ï¼š',
                        type: 'choice',
                        choices: e,
                        cgUrl: this.currentCG
                    }),
                    console.log('ğŸ“‹ é€‰æ‹©é¡¹å·²æ·»åŠ åˆ°å¯¹è¯å†å²')
                }
                showChoiceInput() {
                    const e = $('#player-choice-input');
                    e.length > 0 && (e.fadeIn(300),
                    console.log('ğŸ“ æ˜¾ç¤ºé€‰æ‹©è¾“å…¥æ¡†'),
                    this.bindAddChoiceButton())
                }
                hideChoiceInput() {
                    const e = $('#player-choice-input');
                    e.length > 0 && (e.fadeOut(300),
                    console.log('ğŸ“ éšè—é€‰æ‹©è¾“å…¥æ¡†'))
                }
                bindAddChoiceButton() {
                    $('#add-choice-btn').off('click.addChoice').on('click.addChoice', e => {
                        e.preventDefault(),
                        e.stopPropagation();
                        const t = $('#choice-text-input')
                          , a = t.val();
                        a && a.trim() ? (console.log('ğŸ’­ æ·»åŠ è‡ªå®šä¹‰é€‰æ‹©åˆ°è¡ŒåŠ¨åˆ—è¡¨:', a.trim()),
                        this.addChoiceToCommands(a.trim()),
                        t.val(''),
                        o().success('é€‰æ‹©å·²æ·»åŠ åˆ°è¡ŒåŠ¨åˆ—è¡¨')) : o().warning('è¯·è¾“å…¥é€‰æ‹©å†…å®¹')
                    }
                    )
                }
                addChoiceToCommands(e) {
                    console.log('ğŸ’­ é€‰æ‹©å·²æ·»åŠ åˆ°è¡ŒåŠ¨åˆ—è¡¨:', e)
                }
                async handleChoiceSelection(e, t) {
                    console.log('é€‰æ‹©äº†:', t),
                    $('.dialogue-choices').remove(),
                    this.hideChoiceInput();
                    try {
                        await createChatMessages([{
                            role: 'user',
                            message: t
                        }]),
                        triggerSlash('/trigger')
                    } catch (e) {
                        console.error('å‘é€é€‰æ‹©å¤±è´¥:', e)
                    }
                }
                addToDialogueHistory(e) {
                    if (this.dialogueHistory.push(e),
                    this.dialogueHistory.length > this.MAX_DIALOGUE_HISTORY) {
                        const e = this.dialogueHistory.length - this.MAX_DIALOGUE_HISTORY;
                        this.dialogueHistory.splice(0, e),
                        this.currentDialogueIndex = Math.max(0, this.currentDialogueIndex - e),
                        console.log(`ğŸ“ å¯¹è¯å†å²å·²æ¸…ç†ï¼Œä¿ç•™æœ€æ–°${this.MAX_DIALOGUE_HISTORY}æ¡è®°å½•`)
                    }
                }
                convertToNetworkUrl(e, t='other') {
                    if (e.startsWith('http'))
                        return e;
                    let a = e.split('/').pop() || e;
                    return a.includes('.') || (a += 'background' === t ? '.jpg' : '.png'),
                    'https://60997b0.webp.li/' + a
                }
                preloadDialogueImages() {
                    try {
                        const e = new Set;
                        if (this.dialogueHistory.forEach(t => {
                            t.backgroundUrl && e.add(t.backgroundUrl),
                            t.spriteUrl && e.add(t.spriteUrl),
                            t.cgUrl && e.add(t.cgUrl)
                        }
                        ),
                        0 === e.size)
                            return void console.log('ğŸ“· æœ¬æ¥¼å±‚æ— éœ€é¢„åŠ è½½å›¾ç‰‡');
                        console.log(`ğŸ“· å¼€å§‹é¢„åŠ è½½æœ¬æ¥¼å±‚çš„ ${e.size} å¼ å›¾ç‰‡...`),
                        Promise.all(Array.from(e).map(e => this.stageManager.preloadImage(e).catch(t => {
                            console.warn(`âš ï¸ é¢„åŠ è½½å›¾ç‰‡å¤±è´¥ï¼ˆä¸å½±å“ä½¿ç”¨ï¼‰: ${e}`, t)
                        }
                        ))).then( () => {
                            console.log(`âœ… æœ¬æ¥¼å±‚ ${e.size} å¼ å›¾ç‰‡é¢„åŠ è½½å®Œæˆ`)
                        }
                        ).catch(e => {
                            console.warn('âš ï¸ éƒ¨åˆ†å›¾ç‰‡é¢„åŠ è½½å¤±è´¥ï¼ˆä¸å½±å“ä½¿ç”¨ï¼‰', e)
                        }
                        )
                    } catch (e) {
                        console.warn('âš ï¸ é¢„åŠ è½½å›¾ç‰‡æ—¶å‡ºé”™ï¼ˆä¸å½±å“ä½¿ç”¨ï¼‰:', e)
                    }
                }
                cleanup() {
                    this.stageManager.cleanup(),
                    console.log('LLMRPè§£æå™¨èµ„æºå·²æ¸…ç†')
                }
                async destroy() {
                    this.cleanup(),
                    await this.stageManager.clearStage(),
                    $('.choice-container').remove(),
                    console.log('LLMRPè§£æå™¨å·²é”€æ¯')
                }
                handleCGCommand(e) {
                    const t = this.convertToNetworkUrl(e, 'cg');
                    this.currentCG = t,
                    console.log('ğŸ–¼ï¸ è®°å½•CGçŠ¶æ€:', t)
                }
                handleHideCG() {
                    this.currentCG = null,
                    console.log('ğŸ§¹ è®°å½•éšè—CG')
                }
                showCG(e) {
                    const t = $('#cg-layer')
                      , a = $('#cg-image');
                    a.attr('src') !== e && a.attr('src', e),
                    t.addClass('active'),
                    this.displayedCG = e,
                    this.addCGHoverPreview(a, e),
                    console.log('ğŸ–¼ï¸ æ˜¾ç¤ºCG:', e)
                }
                addCGHoverPreview(e, t) {
                    e.off('click.cgPreview'),
                    console.log('ğŸ”§ ä¸ºCGå›¾ç‰‡æ·»åŠ ç‚¹å‡»é¢„è§ˆåŠŸèƒ½:', t, e.length),
                    e.on('click.cgPreview', e => {
                        e.preventDefault(),
                        e.stopPropagation(),
                        console.log('ğŸ–±ï¸ ç‚¹å‡»CGæ˜¾ç¤ºé¢„è§ˆ:', t),
                        this.showCGPreview(t)
                    }
                    ),
                    e.on('mouseenter', () => {
                        console.log('ğŸ–±ï¸ é¼ æ ‡è¿›å…¥CGåŒºåŸŸ')
                    }
                    )
                }
                async showCGPreview(e) {
                    console.log('ğŸ–¼ï¸ å‡†å¤‡æ˜¾ç¤ºCGé¢„è§ˆå¼¹çª—:', e);
                    try {
                        console.log('ğŸš€ è°ƒç”¨SillyTavern.callGenericPopup');
                        const t = `<img src="${e}" style="max-width: 100%; height: auto;" alt="CGé¢„è§ˆ" />`
                          , a = await SillyTavern.callGenericPopup(t, SillyTavern.POPUP_TYPE.DISPLAY, 'ğŸ–¼ï¸ CGé¢„è§ˆ', {
                            large: !0,
                            wide: !0,
                            okButton: !1,
                            cancelButton: !1
                        });
                        return console.log('âœ… CGé¢„è§ˆå¼¹çª—æ˜¾ç¤ºæˆåŠŸ:', a),
                        setTimeout( () => {
                            this.adjustPopupForImage()
                        }
                        , 100),
                        a
                    } catch (t) {
                        return console.error('âŒ æ˜¾ç¤ºCGé¢„è§ˆå¤±è´¥:', t),
                        o().info(`CGé¢„è§ˆï¼š${e}`),
                        null
                    }
                }
                adjustPopupForImage() {
                    try {
                        const e = $('.popup');
                        if (e.length > 0) {
                            console.log('ğŸ”§ è°ƒæ•´å¼¹çª—å®¹å™¨æ ·å¼'),
                            e.css({
                                'max-width': '95vw',
                                'max-height': '95vh',
                                width: 'auto',
                                height: 'auto',
                                'aspect-ratio': 'unset'
                            });
                            const t = e.find('.popup-content');
                            t.length > 0 && t.css({
                                width: 'auto',
                                height: 'auto',
                                'max-width': '100%',
                                'max-height': '100%',
                                'aspect-ratio': 'unset',
                                display: 'flex',
                                'align-items': 'center',
                                'justify-content': 'center'
                            });
                            const a = e.find('img');
                            a.length > 0 && a.css({
                                'max-width': '100%',
                                'max-height': '85vh',
                                width: 'auto',
                                height: 'auto',
                                'object-fit': 'contain'
                            })
                        }
                    } catch (e) {
                        console.warn('âš ï¸ è°ƒæ•´å¼¹çª—æ ·å¼å¤±è´¥:', e)
                    }
                }
                hideCG() {
                    $('#cg-layer').removeClass('active'),
                    this.displayedCG = null,
                    console.log('ğŸ§¹ éšè—CG')
                }
            }
            class r {
                dataManager;
                uiController;
                llmrpParser;
                constructor(e, t) {
                    this.dataManager = e,
                    this.uiController = t
                }
                setLLMRPParser(e) {
                    this.llmrpParser = e
                }
                initialize() {
                    this.setupNavigationEvents(),
                    this.setupDialogueEvents(),
                    this.setupSettingsEvents(),
                    this.initializeBreathingEffect(),
                    this.initializeKeyboardShortcuts(),
                    this.initializeFullscreen(),
                    console.log('äº‹ä»¶å¤„ç†å™¨åˆå§‹åŒ–å®Œæˆ')
                }
                initializeKeyboardShortcuts() {
                    this.getKeyboardShortcutsEnabled() ? (this.setupKeyboardShortcuts(),
                    console.log('âŒ¨ï¸ åˆå§‹åŒ–é”®ç›˜å¿«æ·é”®: å¼€å¯')) : console.log('âŒ¨ï¸ åˆå§‹åŒ–é”®ç›˜å¿«æ·é”®: å…³é—­')
                }
                initializeFullscreen() {
                    this.getFullscreenEnabled() ? (this.setupFullscreenListener(),
                    console.log('ğŸ–¥ï¸ åˆå§‹åŒ–åŒå‡»å…¨å±: å¼€å¯')) : console.log('ğŸ–¥ï¸ åˆå§‹åŒ–åŒå‡»å…¨å±: å…³é—­')
                }
                initializeBreathingEffect() {
                    const e = this.getBreathingEffectSetting();
                    this.setBreathingEffect(e),
                    console.log('ğŸ« åˆå§‹åŒ–å‘¼å¸æ•ˆæœ: ' + (e ? 'å¼€å¯' : 'å…³é—­'))
                }
                setupNavigationEvents() {
                    $('.nav-btn').off('click.navigation'),
                    $('.nav-btn').on('click.navigation', e => {
                        const t = $(e.currentTarget)
                          , a = t.data('view');
                        a && ($('.nav-btn').removeClass('active'),
                        t.addClass('active'),
                        this.uiController.switchView(a))
                    }
                    )
                }
                setupDialogueEvents() {
                    console.log('ğŸ”§ è®¾ç½®å¯¹è¯äº‹ä»¶...');
                    const e = $('#prev-btn')
                      , t = $('#next-btn');
                    console.log('ğŸ” æŒ‰é’®æ£€æŸ¥:', {
                        prevBtn: e.length,
                        nextBtn: t.length
                    }),
                    e.off('click.dialogue').on('click.dialogue', () => {
                        console.log('ğŸ”™ PrevæŒ‰é’®è¢«ç‚¹å‡»'),
                        this.handleDialogueNavigation('prev')
                    }
                    ),
                    t.off('click.dialogue').on('click.dialogue', () => {
                        console.log('â–¶ï¸ NextæŒ‰é’®è¢«ç‚¹å‡»'),
                        this.handleDialogueNavigation('next')
                    }
                    ),
                    console.log('âœ… å¯¹è¯äº‹ä»¶ç»‘å®šå®Œæˆ'),
                    $('.dialogue-box').off('click.dialogue').on('click.dialogue', e => {
                        $(e.target).closest('.dialogue-controls').length > 0 || this.handleDialogueAdvance()
                    }
                    )
                }
                setupSettingsEvents() {
                    $('#map-btn').off('click.settings'),
                    $('#report-btn').off('click.settings'),
                    $('#contacts-btn').off('click.settings'),
                    $('#schedule-btn').off('click.settings'),
                    $('#quest-btn').off('click.settings'),
                    $('#character-info-btn').off('click.settings'),
                    $('#settings-btn').off('click.settings'),
                    $('.theme-btn').off('click.settings'),
                    $('#breathing-toggle').off('change.settings'),
                    $('#text-animation-type, #text-speed-slider, #font-size-slider').off('change.settings input.settings'),
                    $('#bgm-toggle').off('change.settings'),
                    $('#keyboard-shortcuts-toggle').off('change.settings'),
                    $('#fullscreen-toggle').off('change.settings'),
                    $('#reset-settings-btn').off('click.settings'),
                    $(document).off('click.settings'),
                    $('#map-btn').on('click.settings', e => {
                        e.stopPropagation();
                        const t = $('#map-menu')
                          , a = $('#app-container')
                          , n = $('#settings-menu')
                          , s = $('#character-info-menu')
                          , i = $('#quest-menu')
                          , o = $('#schedule-menu')
                          , r = $('#contacts-menu')
                          , m = $('#report-menu');
                        n.removeClass('active'),
                        s.removeClass('active'),
                        i.removeClass('active'),
                        o.removeClass('active'),
                        r.removeClass('active'),
                        m.removeClass('active'),
                        t.toggleClass('active'),
                        t.hasClass('active') ? (a.addClass('modal-active'),
                        this.initMapPanel(),
                        console.log('ğŸ—ºï¸ æ‰“å¼€åœ°å›¾é¢æ¿')) : (a.removeClass('modal-active'),
                        console.log('ğŸ—ºï¸ å…³é—­åœ°å›¾é¢æ¿'))
                    }
                    ),
                    $('#report-btn').on('click.settings', e => {
                        e.stopPropagation();
                        const t = $('#report-menu')
                          , a = $('#app-container')
                          , n = $('#settings-menu')
                          , s = $('#character-info-menu')
                          , i = $('#quest-menu')
                          , o = $('#schedule-menu')
                          , r = $('#contacts-menu')
                          , m = $('#map-menu');
                        n.removeClass('active'),
                        s.removeClass('active'),
                        i.removeClass('active'),
                        o.removeClass('active'),
                        r.removeClass('active'),
                        m.removeClass('active'),
                        t.toggleClass('active'),
                        t.hasClass('active') ? (a.addClass('modal-active'),
                        this.initReportPanel(),
                        console.log('ğŸ“Š æ‰“å¼€å‘¨æŠ¥/æ—¥æŠ¥é¢æ¿')) : (a.removeClass('modal-active'),
                        console.log('ğŸ“Š å…³é—­å‘¨æŠ¥/æ—¥æŠ¥é¢æ¿'))
                    }
                    ),
                    $('#contacts-btn').on('click.settings', e => {
                        e.stopPropagation();
                        const t = $('#contacts-menu')
                          , a = $('#app-container')
                          , n = $('#settings-menu')
                          , s = $('#character-info-menu')
                          , i = $('#quest-menu')
                          , o = $('#schedule-menu')
                          , r = $('#report-menu')
                          , m = $('#map-menu');
                        n.removeClass('active'),
                        s.removeClass('active'),
                        i.removeClass('active'),
                        o.removeClass('active'),
                        r.removeClass('active'),
                        m.removeClass('active'),
                        t.toggleClass('active'),
                        t.hasClass('active') ? (a.addClass('modal-active'),
                        this.initContactsPanel(),
                        console.log('ğŸ‘¥ æ‰“å¼€è”ç³»äººé¢æ¿')) : (a.removeClass('modal-active'),
                        console.log('ğŸ‘¥ å…³é—­è”ç³»äººé¢æ¿'))
                    }
                    ),
                    $('#schedule-btn').on('click.settings', e => {
                        e.stopPropagation();
                        const t = $('#schedule-menu')
                          , a = $('#app-container')
                          , n = $('#settings-menu')
                          , s = $('#character-info-menu')
                          , i = $('#quest-menu')
                          , o = $('#contacts-menu')
                          , r = $('#report-menu')
                          , m = $('#map-menu');
                        n.removeClass('active'),
                        s.removeClass('active'),
                        i.removeClass('active'),
                        o.removeClass('active'),
                        r.removeClass('active'),
                        m.removeClass('active'),
                        t.toggleClass('active'),
                        t.hasClass('active') ? (a.addClass('modal-active'),
                        console.log('ğŸ“… æ‰“å¼€æ—¥ç¨‹é¢æ¿')) : (a.removeClass('modal-active'),
                        console.log('ğŸ“… å…³é—­æ—¥ç¨‹é¢æ¿'))
                    }
                    ),
                    $('#quest-btn').on('click.settings', e => {
                        e.stopPropagation();
                        const t = $('#quest-menu')
                          , a = $('#app-container')
                          , n = $('#settings-menu')
                          , s = $('#character-info-menu')
                          , i = $('#schedule-menu')
                          , o = $('#contacts-menu')
                          , r = $('#report-menu')
                          , m = $('#map-menu');
                        n.removeClass('active'),
                        s.removeClass('active'),
                        i.removeClass('active'),
                        o.removeClass('active'),
                        r.removeClass('active'),
                        m.removeClass('active'),
                        t.toggleClass('active'),
                        t.hasClass('active') ? (a.addClass('modal-active'),
                        console.log('ğŸ“‹ æ‰“å¼€ä»»åŠ¡é¢æ¿')) : (a.removeClass('modal-active'),
                        console.log('ğŸ“‹ å…³é—­ä»»åŠ¡é¢æ¿'))
                    }
                    ),
                    $('#character-info-btn').on('click.settings', e => {
                        e.stopPropagation();
                        const t = $('#character-info-menu')
                          , a = $('#app-container')
                          , n = $('#settings-menu')
                          , s = $('#quest-menu')
                          , i = $('#schedule-menu')
                          , o = $('#contacts-menu')
                          , r = $('#report-menu')
                          , m = $('#map-menu');
                        n.removeClass('active'),
                        s.removeClass('active'),
                        i.removeClass('active'),
                        o.removeClass('active'),
                        r.removeClass('active'),
                        m.removeClass('active'),
                        t.toggleClass('active'),
                        t.hasClass('active') ? (a.addClass('modal-active'),
                        this.initCharacterInfo(),
                        console.log('ğŸ‘¤ æ‰“å¼€äººç‰©ä¿¡æ¯é¢æ¿')) : (a.removeClass('modal-active'),
                        console.log('ğŸ‘¤ å…³é—­äººç‰©ä¿¡æ¯é¢æ¿'))
                    }
                    ),
                    $('#settings-btn').on('click.settings', e => {
                        e.stopPropagation();
                        const t = $('#settings-menu')
                          , a = $('#app-container')
                          , n = $('#character-info-menu')
                          , s = $('#quest-menu')
                          , i = $('#schedule-menu')
                          , o = $('#contacts-menu')
                          , r = $('#report-menu')
                          , m = $('#map-menu');
                        n.removeClass('active'),
                        s.removeClass('active'),
                        i.removeClass('active'),
                        o.removeClass('active'),
                        r.removeClass('active'),
                        m.removeClass('active'),
                        t.toggleClass('active'),
                        t.hasClass('active') ? (a.addClass('modal-active'),
                        this.initBreathingToggleState(),
                        this.initTextSettingsState(),
                        this.initBGMSettingsState(),
                        this.initKeyboardShortcutsState(),
                        this.initFullscreenState(),
                        console.log('ğŸ¨ æ¿€æ´»èƒŒæ™¯æ¨¡ç³Šæ•ˆæœ')) : (a.removeClass('modal-active'),
                        console.log('ğŸ¨ å–æ¶ˆèƒŒæ™¯æ¨¡ç³Šæ•ˆæœ'))
                    }
                    ),
                    $('.theme-btn').on('click.settings', e => {
                        const t = $(e.currentTarget)
                          , a = t.data('theme');
                        a && ($('.theme-btn').removeClass('active'),
                        t.addClass('active'),
                        this.applyTheme(a))
                    }
                    ),
                    $('#breathing-toggle').on('change.settings', e => {
                        const t = $(e.currentTarget).is(':checked');
                        this.setBreathingEffect(t),
                        console.log('ğŸ« å‘¼å¸æ•ˆæœå·²' + (t ? 'å¼€å¯' : 'å…³é—­'))
                    }
                    ),
                    $('#text-animation-type').on('change.settings', e => {
                        const t = $(e.currentTarget).val();
                        console.log(`ğŸ“ æ–‡å­—åŠ¨ç”»ç±»å‹åˆ‡æ¢ä¸º: ${t}`);
                        const a = this.llmrpParser?.getTextAnimationManager();
                        a && a.setAnimationType(t)
                    }
                    ),
                    $('#text-speed-slider').on('input.settings', e => {
                        let t = 210 - parseInt($(e.currentTarget).val(), 10);
                        Number.isNaN(t) && (t = 50),
                        t = Math.max(10, Math.min(200, t)),
                        $('#text-speed-value').text(`${t}ms`);
                        const a = this.llmrpParser?.getTextAnimationManager();
                        a && a.setAnimationSpeed(t)
                    }
                    ),
                    $('#font-size-slider').on('input.settings', e => {
                        const t = parseInt($(e.currentTarget).val(), 10);
                        $('#font-size-value').text(`${t}px`);
                        const a = this.llmrpParser?.getTextAnimationManager();
                        a && a.setFontSize(t)
                    }
                    ),
                    $('#bgm-toggle').on('change.settings', async e => {
                        const t = $(e.currentTarget).is(':checked');
                        await this.setBGMEnabled(t),
                        console.log(`ğŸµ BGMæ’­æ”¾å™¨${t ? 'å¼€å¯' : 'å…³é—­'}å®Œæˆ`)
                    }
                    ),
                    $('#keyboard-shortcuts-toggle').on('change.settings', e => {
                        const t = $(e.currentTarget).is(':checked');
                        this.setKeyboardShortcutsEnabled(t),
                        console.log('âŒ¨ï¸ é”®ç›˜å¿«æ·é”®å·²' + (t ? 'å¼€å¯' : 'å…³é—­'))
                    }
                    ),
                    $('#fullscreen-toggle').on('change.settings', e => {
                        const t = $(e.currentTarget).is(':checked');
                        this.setFullscreenEnabled(t),
                        console.log('ğŸ–¥ï¸ åŒå‡»å…¨å±å·²' + (t ? 'å¼€å¯' : 'å…³é—­'))
                    }
                    ),
                    $('#reset-settings-btn').on('click.settings', e => {
                        e.stopPropagation();
                        confirm('ç¡®å®šè¦æ¢å¤æ‰€æœ‰è®¾ç½®ä¸ºé»˜è®¤å€¼å—ï¼Ÿ') && (this.resetToDefaultSettings(),
                        console.log('ğŸ”„ è®¾ç½®å·²æ¢å¤ä¸ºé»˜è®¤å€¼'))
                    }
                    ),
                    $(document).on('click.settings', e => {
                        if (!$(e.target).closest('#settings-btn, #settings-menu, #character-info-btn, #character-info-menu, #quest-btn, #quest-menu, #schedule-btn, #schedule-menu, #contacts-btn, #contacts-menu, #report-btn, #report-menu, #map-btn, #map-menu').length) {
                            const e = $('#settings-menu')
                              , t = $('#character-info-menu')
                              , n = $('#quest-menu')
                              , s = $('#schedule-menu')
                              , i = $('#contacts-menu')
                              , r = $('#report-menu')
                              , m = $('#map-menu')
                              , a = $('#app-container');
                            e.hasClass('active') && (e.removeClass('active'),
                            a.removeClass('modal-active'),
                            console.log('ğŸ¨ å…³é—­è®¾ç½®èœå•ï¼Œå–æ¶ˆèƒŒæ™¯æ¨¡ç³Š')),
                            t.hasClass('active') && (t.removeClass('active'),
                            a.removeClass('modal-active'),
                            console.log('ğŸ‘¤ å…³é—­äººç‰©ä¿¡æ¯é¢æ¿ï¼Œå–æ¶ˆèƒŒæ™¯æ¨¡ç³Š')),
                            n.hasClass('active') && (n.removeClass('active'),
                            a.removeClass('modal-active'),
                            console.log('ğŸ“‹ å…³é—­ä»»åŠ¡é¢æ¿ï¼Œå–æ¶ˆèƒŒæ™¯æ¨¡ç³Š')),
                            s.hasClass('active') && (s.removeClass('active'),
                            a.removeClass('modal-active'),
                            console.log('ğŸ“… å…³é—­æ—¥ç¨‹é¢æ¿ï¼Œå–æ¶ˆèƒŒæ™¯æ¨¡ç³Š')),
                            i.hasClass('active') && (i.removeClass('active'),
                            a.removeClass('modal-active'),
                            console.log('ğŸ‘¥ å…³é—­è”ç³»äººé¢æ¿ï¼Œå–æ¶ˆèƒŒæ™¯æ¨¡ç³Š')),
                            r.hasClass('active') && (r.removeClass('active'),
                            a.removeClass('modal-active'),
                            console.log('ğŸ“Š å…³é—­å‘¨æŠ¥/æ—¥æŠ¥é¢æ¿ï¼Œå–æ¶ˆèƒŒæ™¯æ¨¡ç³Š')),
                            m.hasClass('active') && (m.removeClass('active'),
                            a.removeClass('modal-active'),
                            console.log('ğŸ—ºï¸ å…³é—­åœ°å›¾é¢æ¿ï¼Œå–æ¶ˆèƒŒæ™¯æ¨¡ç³Š'))
                        }
                    }
                    )
                }
                initContactsPanel() {
                    $('.contact-card').off('click.contacts').on('click.contacts', function(e) {
                        e.stopPropagation();
                        $('.contact-card').removeClass('active');
                        $(this).addClass('active');
                        const t = $(this).find('.contact-name').text()
                          , a = $(this).find('.contact-avatar img').attr('src');
                        $('#chat-contact-name').text(t);
                        $('#chat-avatar img').attr('src', a);
                        console.log('ğŸ‘¤ åˆ‡æ¢è”ç³»äºº:', t)
                    }
                    );
                    $('#chat-send-btn').off('click.chat').on('click.chat', () => {
                        this.sendChatMessage()
                    }
                    );
                    $('#chat-input').off('keypress.chat').on('keypress.chat', e => {
                        13 === e.which && (e.preventDefault(),
                        this.sendChatMessage())
                    }
                    )
                }
                sendChatMessage() {
                    const e = $('#chat-input')
                      , t = e.val().trim();
                    if (!t)
                        return;
                    const a = new Date
                      , n = String(a.getHours()).padStart(2, '0') + ':' + String(a.getMinutes()).padStart(2, '0')
                      , s = `\n        <div class="message sent">\n            <div class="message-content">\n                <div class="message-text">${$('<div>').text(t).html()}</div>\n                <div class="message-time">${n}</div>\n            </div>\n        </div>\n    `
                      , i = $('#chat-messages');
                    i.append(s);
                    const o = i.find('.message');
                    o.length > 7 && o.first().remove();
                    i.scrollTop(i[0].scrollHeight);
                    e.val('');
                    console.log('ğŸ’¬ å‘é€æ¶ˆæ¯:', t)
                }
                initCharacterInfo() {
                    this.updateCircularProgress('power', 65);
                    this.updateCircularProgress('desire', 80);
                    this.updateBarProgress('energy', 45);
                }
                updateCircularProgress(e, t) {
                    const a = Math.max(0, Math.min(100, t))
                      , n = 213.628
                      , s = n - n * a / 100;
                    $(`[data-stat="${e}"] .progress-ring-circle`).css('stroke-dashoffset', s),
                    $(`#${e}-value`).text(`${a}%`)
                }
                updateBarProgress(e, t) {
                    const a = Math.max(0, Math.min(100, t));
                    $(`#${e}-bar`).css('width', `${a}%`),
                    $(`#${e}-value`).text(`${a}%`)
                }
                initReportPanel() {
                    this.updateReportDate();
                    $('.report-type-btn').off('click.report').on('click.report', e => {
                        e.stopPropagation();
                        const t = $(e.currentTarget);
                        const a = t.data('type');
                        $('.report-type-btn').removeClass('active');
                        t.addClass('active');
                        this.updateReportDate();
                        console.log(`ğŸ“Š åˆ‡æ¢æŠ¥å‘Šç±»å‹: ${a}`)
                    });
                }
                updateReportDate() {
                    const e = new Date();
                    const t = e.getFullYear();
                    const a = e.getMonth() + 1;
                    const n = e.getDate();
                    const s = $('.report-type-btn.active').data('type');
                    let dateStr;
                    if (s === 'daily') {
                        dateStr = `${t}å¹´${a}æœˆ${n}æ—¥`;
                    } else {
                        const weekStart = new Date(e);
                        weekStart.setDate(e.getDate() - e.getDay() + 1);
                        const weekEnd = new Date(weekStart);
                        weekEnd.setDate(weekStart.getDate() + 6);
                        dateStr = `${t}å¹´${a}æœˆ ç¬¬${Math.ceil(n / 7)}å‘¨`;
                    }
                    $('#report-date').text(dateStr);
                }
                initMapPanel() {
                    this.currentMapIndex = 0;
                    this.updateMapDisplay();
                    $('#map-prev-btn').off('click.map').on('click.map', e => {
                        e.stopPropagation();
                        this.navigateMap('prev');
                    });
                    $('#map-next-btn').off('click.map').on('click.map', e => {
                        e.stopPropagation();
                        this.navigateMap('next');
                    });
                    $('.indicator-dot').off('click.map').on('click.map', e => {
                        e.stopPropagation();
                        const t = $(e.currentTarget).data('slide');
                        this.currentMapIndex = t;
                        this.updateMapDisplay();
                    });
                    $('.map-marker').off('click.map').on('click.map', e => {
                        e.stopPropagation();
                        const t = $(e.currentTarget).data('location');
                        this.goToLocation(t);
                    });
                    console.log('ğŸ—ºï¸ åœ°å›¾é¢æ¿å·²åˆå§‹åŒ–');
                }
                navigateMap(e) {
                    const t = $('.map-slide').length;
                    if (e === 'prev') {
                        this.currentMapIndex = (this.currentMapIndex - 1 + t) % t;
                    } else {
                        this.currentMapIndex = (this.currentMapIndex + 1) % t;
                    }
                    this.updateMapDisplay();
                }
                updateMapDisplay() {
                    const e = $('.map-slide');
                    const t = e.eq(this.currentMapIndex);
                    const a = t.data('map-name');
                    e.removeClass('active');
                    t.addClass('active');
                    $('#current-map-name').text(a);
                    $('.indicator-dot').removeClass('active');
                    $(`.indicator-dot[data-slide="${this.currentMapIndex}"]`).addClass('active');
                    const n = -this.currentMapIndex * 100;
                    $('#map-image-wrapper').css('transform', `translateX(${n}%)`);
                    console.log(`ğŸ—ºï¸ åˆ‡æ¢åˆ°åœ°å›¾: ${a}`);
                }
                goToLocation(e) {
                    const t = $('#choice-text-input');
                    if (t.length) {
                        t.val(`å‰å»${e}`);
                        t.focus();
                        console.log(`ğŸ“ å·²é€‰æ‹©ä½ç½®: ${e}`);
                        const a = $('#player-choice-input');
                        if (a.length && a.css('display') === 'none') {
                            console.log('ğŸ’¡ æç¤º: è¾“å…¥æ¡†å½“å‰å¤„äºéšè—çŠ¶æ€ï¼Œæ–‡æœ¬å·²å¡«å…¥ä½†å¯èƒ½ä¸å¯è§');
                        }
                        $('#map-menu').removeClass('active');
                        $('#app-container').removeClass('modal-active');
                        console.log('ğŸ—ºï¸ å…³é—­åœ°å›¾é¢æ¿');
                    } else {
                        console.warn('âš ï¸ æœªæ‰¾åˆ°è¾“å…¥æ¡†å…ƒç´  #choice-text-input');
                    }
                }
                async handleDialogueNavigation(e) {
                    if (console.log(`ğŸ“– å¯¹è¯å¯¼èˆª: ${e}`),
                    'next' === e) {
                        if (this.llmrpParser) {
                            if (await this.llmrpParser.navigateNext())
                                return void console.log('ğŸ“„ æ˜¾ç¤ºä¸‹ä¸€æ¡å¯¹è¯')
                        }
                        console.log('ğŸ“„ å·²æ˜¯æœ€æ–°å¯¹è¯ (ä¸è‡ªåŠ¨å‘é€)')
                    } else {
                        if (this.llmrpParser) {
                            if (await this.llmrpParser.navigatePrevious())
                                return void console.log('ğŸ“„ æ˜¾ç¤ºä¸Šä¸€æ¡å¯¹è¯')
                        }
                        console.log('ğŸ“„ å·²æ˜¯æœ€æ—©å¯¹è¯ (ä¸è‡ªåŠ¨å‘é€)')
                    }
                }
                handleDialogueAdvance() {
                    const e = this.llmrpParser?.getTextAnimationManager();
                    if (e && e.isPlaying())
                        return e.skipAnimation(),
                        void console.log('ğŸ“ ç‚¹å‡»å¯¹è¯æ¡†ï¼šè·³è¿‡æ–‡å­—åŠ¨ç”»');
                    this.handleDialogueNavigation('next'),
                    console.log('ğŸ“– ç‚¹å‡»å¯¹è¯æ¡†ï¼šå°è¯•è¿›å…¥ä¸‹ä¸€å¥å¯¹è¯')
                }
                applyTheme(e) {
                    $('body').attr('data-theme', e);
                    try {
                        localStorage.setItem('iswp_theme', e)
                    } catch {}
                    try {
                        document.cookie = `iswp_theme=${encodeURIComponent(e)}; path=/; max-age=31536000`
                    } catch {}
                    console.log(`åº”ç”¨ä¸»é¢˜å¹¶å·²ä¿å­˜: ${e}`)
                }
                setBreathingEffect(e) {
                    try {
                        localStorage.setItem('iswp_breathing', e.toString())
                    } catch (e) {
                        console.warn('Could not save breathing setting to localStorage', e)
                    }
                    try {
                        document.cookie = `iswp_breathing=${e}; path=/; max-age=31536000`
                    } catch (e) {
                        console.warn('Could not save breathing setting to cookie', e)
                    }
                    e ? window.enableBreathing?.() : window.disableBreathing?.()
                }
                initBreathingToggleState() {
                    const e = this.getBreathingEffectSetting();
                    $('#breathing-toggle').prop('checked', e)
                }
                initTextSettingsState() {
                    const e = this.llmrpParser?.getTextAnimationManager();
                    if (!e)
                        return;
                    const t = e.getSettings();
                    $('#text-animation-type').val(t.type);
                    const a = t.speed
                      , n = 210 - a;
                    $('#text-speed-slider').val(n),
                    $('#text-speed-value').text(`${a}ms`),
                    $('#font-size-slider').val(t.fontSize),
                    $('#font-size-value').text(`${t.fontSize}px`)
                }
                getBreathingEffectSetting() {
                    try {
                        const e = localStorage.getItem('iswp_breathing');
                        if (null !== e)
                            return 'true' === e;
                        const t = document.cookie.match(/(?:^|; )iswp_breathing=([^;]+)/);
                        if (t)
                            return 'true' === t[1]
                    } catch {}
                    return !0
                }
                resetToDefaultSettings() {
                    try {
                        this.applyTheme('dark'),
                        $('.theme-btn').removeClass('active'),
                        $('.theme-btn[data-theme="dark"]').addClass('active'),
                        $('#breathing-toggle').prop('checked', !0),
                        this.setBreathingEffect(!0);
                        const e = 50
                          , t = 210 - e;
                        $('#text-animation-type').val('typewriter'),
                        $('#text-speed-slider').val(t),
                        $('#text-speed-value').text(`${e}ms`),
                        $('#font-size-slider').val('16'),
                        $('#font-size-value').text('16px');
                        const a = this.llmrpParser?.getTextAnimationManager();
                        a && (a.setAnimationType('typewriter'),
                        a.setAnimationSpeed(e),
                        a.setFontSize(16)),
                        $('#bgm-toggle').prop('checked', !0),
                        this.setBGMEnabled(!0),
                        $('#fullscreen-toggle').prop('checked', !1),
                        this.setFullscreenEnabled(!1),
                        o().success('è®¾ç½®å·²æ¢å¤ä¸ºé»˜è®¤å€¼')
                    } catch (e) {
                        console.error('æ¢å¤é»˜è®¤è®¾ç½®æ—¶å‡ºé”™:', e),
                        o().error('æ¢å¤é»˜è®¤è®¾ç½®å¤±è´¥')
                    }
                }
                initBGMSettingsState() {
                    const e = this.getBGMEnabledSetting();
                    $('#bgm-toggle').prop('checked', e),
                    this.setBGMEnabled(e)
                }
                async setBGMEnabled(e) {
                    try {
                        localStorage.setItem('iswp_bgm_enabled', e.toString())
                    } catch (e) {
                        console.warn('Could not save BGM enabled setting to localStorage', e)
                    }
                    try {
                        console.log(`ğŸµ æ­£åœ¨${e ? 'å¼€å¯' : 'å…³é—­'}BGMæ’­æ”¾å™¨...`),
                        e ? ('undefined' != typeof audioEnable && (await audioEnable({
                            type: 'bgm',
                            state: 'true'
                        }),
                        console.log('âœ… BGMæ’­æ”¾å™¨å·²å¯ç”¨')),
                        'undefined' != typeof audioPlay && (await audioPlay({
                            type: 'bgm',
                            play: 'true'
                        }),
                        console.log('âœ… BGMæ’­æ”¾å·²å¼€å§‹/æ¢å¤'))) : ('undefined' != typeof audioPlay && (await audioPlay({
                            type: 'bgm',
                            play: 'false'
                        }),
                        console.log('âœ… BGMæ’­æ”¾å·²æš‚åœ')),
                        'undefined' != typeof audioEnable && (await audioEnable({
                            type: 'bgm',
                            state: 'false'
                        }),
                        console.log('âœ… BGMæ’­æ”¾å™¨å·²ç¦ç”¨'))),
                        console.log(`ğŸµ BGM${e ? 'å¼€å¯' : 'å…³é—­'}æ“ä½œå®Œæˆ`)
                    } catch (e) {
                        console.error('âŒ è®¾ç½®BGMå¼€å…³æ—¶å‡ºé”™:', e);
                        const t = Object.keys(window).filter(e => e.startsWith('audio'));
                        console.log('å¯ç”¨çš„éŸ³é¢‘API:', t),
                        t.length || console.warn('âš ï¸ é…’é¦†åŠ©æ‰‹éŸ³é¢‘APIå®Œå…¨ä¸å¯ç”¨ï¼Œå¯èƒ½éœ€è¦å…ˆå¯ç”¨éŸ³é¢‘æ’­æ”¾å™¨æ’ä»¶')
                    }
                }
                getBGMEnabledSetting() {
                    try {
                        const e = localStorage.getItem('iswp_bgm_enabled');
                        if (null !== e)
                            return 'true' === e
                    } catch {}
                    return !0
                }
                initKeyboardShortcutsState() {
                    const e = this.getKeyboardShortcutsEnabled();
                    $('#keyboard-shortcuts-toggle').prop('checked', e)
                }
                setKeyboardShortcutsEnabled(e) {
                    try {
                        localStorage.setItem('iswp_keyboard_shortcuts_enabled', e.toString())
                    } catch (e) {
                        console.warn('Could not save keyboard shortcuts setting', e)
                    }
                    e ? this.setupKeyboardShortcuts() : this.cleanupKeyboardShortcuts()
                }
                getKeyboardShortcutsEnabled() {
                    try {
                        const e = localStorage.getItem('iswp_keyboard_shortcuts_enabled');
                        if (null !== e)
                            return 'true' === e
                    } catch {}
                    return !1
                }
                setupKeyboardShortcuts() {
                    this.cleanupKeyboardShortcuts(),
                    $(document).on('keydown.shortcuts', e => {
                        if ('Escape' === e.key && $('#modal-container').hasClass('active'))
                            return e.preventDefault(),
                            void $('#modal-close-btn').trigger('click');
                        if (this.shouldHandleKeyboard())
                            switch (e.key) {
                            case ' ':
                            case 'ArrowRight':
                                e.preventDefault(),
                                $('#next-btn').trigger('click');
                                break;
                            case 'ArrowLeft':
                                e.preventDefault(),
                                $('#prev-btn').trigger('click')
                            }
                    }
                    )
                }
                shouldHandleKeyboard() {
                    return !($('input:focus, textarea:focus').length > 0) && !($('#modal-container').hasClass('active') && !($('.dialogue-choices').length > 0))
                }
                cleanupKeyboardShortcuts() {
                    $(document).off('.shortcuts')
                }
                initFullscreenState() {
                    const e = this.getFullscreenEnabled();
                    $('#fullscreen-toggle').prop('checked', e)
                }
                setFullscreenEnabled(e) {
                    try {
                        localStorage.setItem('iswp_fullscreen_enabled', e.toString())
                    } catch (e) {
                        console.warn('Could not save fullscreen setting', e)
                    }
                    e ? this.setupFullscreenListener() : this.cleanupFullscreenListener()
                }
                getFullscreenEnabled() {
                    try {
                        const e = localStorage.getItem('iswp_fullscreen_enabled');
                        if (null !== e)
                            return 'true' === e
                    } catch {}
                    return !1
                }
                setupFullscreenListener() {
                    this.cleanupFullscreenListener(),
                    $('#app-container').on('dblclick.fullscreen', e => {
                        $(e.target).closest('.dialogue-box').length > 0 || $(e.target).closest('#modal-container').length > 0 || $(e.target).closest('#settings-menu').length > 0 || this.toggleFullscreen()
                    }
                    )
                }
                cleanupFullscreenListener() {
                    $('#app-container').off('.fullscreen')
                }
                toggleFullscreen() {
                    try {
                        document.fullscreenElement ? document.exitFullscreen().catch(e => {
                            console.log(`æ— æ³•é€€å‡ºå…¨å±æ¨¡å¼: ${e.message}`)
                        }
                        ) : document.documentElement.requestFullscreen().catch(e => {
                            console.log(`æ— æ³•è¿›å…¥å…¨å±æ¨¡å¼: ${e.message}`)
                        }
                        )
                    } catch (e) {
                        console.error('å…¨å±åˆ‡æ¢å¤±è´¥:', e)
                    }
                }
                destroy() {
                    this.cleanupKeyboardShortcuts(),
                    this.cleanupFullscreenListener(),
                    $('.nav-btn').off('.navigation'),
                    $('#prev-btn, #next-btn').off('.dialogue'),
                    $('.dialogue-box').off('.dialogue'),
                    $('#map-btn, #report-btn, #contacts-btn, #schedule-btn, #quest-btn, #character-info-btn, #settings-btn, .theme-btn').off('.settings'),
                    $('#text-animation-type, #text-speed-slider, #font-size-slider').off('.settings'),
                    $('#bgm-toggle, #fullscreen-toggle').off('.settings'),
                    $('.contact-card').off('.contacts'),
                    $('#chat-send-btn').off('.chat'),
                    $('#chat-input').off('.chat'),
                    $('.report-type-btn').off('.report'),
                    $('#map-prev-btn, #map-next-btn').off('.map'),
                    $('.indicator-dot').off('.map'),
                    $('.map-marker').off('.map'),
                    $(document).off('.settings'),
                    console.log('äº‹ä»¶å¤„ç†å™¨å·²é”€æ¯')
                }
            }
            class u {
                dataManager;
                currentView = 'novel';
                commandManager;
                constructor(e) {
                    this.dataManager = e
                }
                getCurrentView() {
                    return this.currentView
                }
                getCommandManager() {
                    return this.commandManager
                }
                initialize() {
                    this.renderInitialUI(),
                    this.setupViewSwitching(),
                    console.log('UIæ§åˆ¶å™¨åˆå§‹åŒ–å®Œæˆ')
                }
                renderInitialUI() {
                    this.updateDialogue()
                }
                updateDialogue() {
                    const e = $('#speaker-name').text()
                      , t = $('#dialogue-content').text();
                    e && '' !== e.trim() || $('#speaker-name').text(''),
                    t && '' !== t.trim() || $('#dialogue-content').text('')
                }
                setupViewSwitching() {}
                switchView(e) {
                    console.log('ğŸ”„ åˆ‡æ¢è§†å›¾åˆ°:', e),
                    this.currentView = e;
                    const t = $('#app-container')
                      , a = $('#modal-container')
                      , n = a.find('.view-container')
                      , s = a.hasClass('active');
                    if ('novel' === e)
                        return n.removeClass('active'),
                        a.removeClass('active'),
                        t.removeClass('modal-active'),
                        void console.log('ğŸ“± æ˜¾ç¤ºä¸»ç•Œé¢ï¼Œå–æ¶ˆèƒŒæ™¯æ¨¡ç³Š');
                    switch (n.removeClass('active'),
                    $(`#view-${e}`).addClass('active'),
                    s ? console.log('ğŸ¯ ä¿æŒæ¨¡æ€å®¹å™¨å¼€å¯ï¼Œä»…åˆ‡æ¢å†…éƒ¨è§†å›¾') : requestAnimationFrame( () => {
                        a.addClass('active'),
                        t.addClass('modal-active'),
                        console.log('ğŸ¨ æ˜¾ç¤ºæ¨¡æ€ç•Œé¢ï¼Œæ¿€æ´»èƒŒæ™¯æ¨¡ç³Š')
                    }
                    ),
                    e) {
                    case 'memoir':
                        this.renderMemoirView()
                    }
                }
                _currentMemoir = [];
                setCurrentMemoir(e) {
                    this._currentMemoir = Array.isArray(e) ? e : []
                }
                renderMemoirView() {
                    try {
                        const e = $('#view-memoir #event-list')
                          , t = $('#view-memoir #event-details');
                        e.empty(),
                        t.empty();
                        const a = this._currentMemoir || [];
                        if (!a.length)
                            return void e.html('<div class="empty-hint">æš‚æ— å›å¿†</div>');
                        const n = [];
                        n.push('<ul class="memoir-list">');
                        for (let e = 0; e < a.length; e++) {
                            const t = a[e]
                              , s = t && 'object' == typeof t && !Array.isArray(t)
                              , i = String(s ? t.text ?? '' : t ?? '')
                              , o = $('<div>').text(i).html().replace(/\n/g, '<br/>')
                              , r = String(s ? t.speaker ?? '' : '').trim()
                              , c = r || 'æ—ç™½'
                              , l = `<div class="memoir-speaker">${$('<div>').text(c).html()}</div>`;
                            n.push(`<li class="memoir-item">\n             <div class="memoir-meta">\n               ${l}\n               <div class="memoir-text">${o}</div>\n             </div>\n           </li>`)
                        }
                        n.push('</ul>'),
                        e.html(n.join(''))
                    } catch (e) {
                        console.warn('æ¸²æŸ“å›å¿†å½•è§†å›¾å¤±è´¥:', e),
                        $('#view-memoir #event-list').html('<div class="empty-hint">æ— æ³•åŠ è½½å›å¿†å½•</div>')
                    }
                }
                updateUI() {
                    this.updateDialogue()
                }
                destroy() {
                    console.log('UIæ§åˆ¶å™¨å·²é”€æ¯')
                }
            }
            let p = null
              , v = null
              , f = null
              , y = null;
            async function C() {
                try {
                    console.log('å¼‚ä¸–ç•Œå’Œå¹³ç•Œé¢å¼€å§‹åŠ è½½...'),
                    function() {
                        try {
                            let e = localStorage.getItem('iswp_theme');
                            if (!e) {
                                const t = document.cookie.match(/(?:^|; )iswp_theme=([^;]+)/);
                                e = t ? decodeURIComponent(t[1]) : ''
                            }
                            e || (e = 'dark'),
                            $('body').attr('data-theme', e),
                            $('.theme-btn').removeClass('active'),
                            $(`.theme-btn[data-theme="${e}"]`).addClass('active')
                        } catch (e) {
                            $('body').attr('data-theme', 'dark'),
                            $('.theme-btn').removeClass('active'),
                            $('.theme-btn[data-theme="dark"]').addClass('active')
                        }
                    }(),
                    p = {},
                    v = new u(p),
                    v.initialize(),
                    window.enableBreathing = M,
                    window.disableBreathing = I,
                    f = new r(p,v),
                    f.initialize(),
                    y = new h(p,v),
                    y.initialize(),
                    f.setLLMRPParser(y),
                    function() {
                        let e = null
                          , t = null;
                        const a = setInterval( () => {
                            if (p && v && y)
                                try {
                                    if ('undefined' == typeof getCurrentMessageId || 'undefined' == typeof getChatMessages)
                                        return;
                                    const a = getCurrentMessageId()
                                      , n = getChatMessages(a)[0];
                                    if (n && n.message) {
                                        const s = n.message || '';
                                        if (a === e && s === t)
                                            return;
                                        s.includes('<game_response>') && (console.log('ğŸ® æ£€æµ‹åˆ°æ–°çš„LLMRPæ¶ˆæ¯ï¼Œå¼€å§‹è§£æ...'),
                                        console.log('ğŸ“ æ¶ˆæ¯ID:', a, 'ä¸Šæ¬¡ID:', e),
                                        console.log('ğŸ“ æ¶ˆæ¯å†…å®¹:', s),
                                        e = a,
                                        t = s,
                                        (async () => {
                                            try {
                                                await y.parseAndExecute(s),
                                                console.log('âœ… LLMRPæ¶ˆæ¯è§£æå®Œæˆ:', a)
                                            } catch (a) {
                                                console.error('âŒ LLMRPè§£æå‡ºé”™:', a),
                                                e = null,
                                                t = null
                                            }
                                        }
                                        )())
                                    }
                                } catch (e) {}
                            else
                                clearInterval(a)
                        }
                        , 1e3);
                        window.gameMessageInterval = a
                    }(),
                    console.log('å¼‚ä¸–ç•Œå’Œå¹³ç•Œé¢åŠ è½½å®Œæˆ')
                } catch (t) {
                    console.error('å¼‚ä¸–ç•Œå’Œå¹³ç•Œé¢åŠ è½½å¤±è´¥:', t),
                    e = 'ç•Œé¢åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•',
                    'undefined' != typeof toastr ? toastr.error(e, 'é”™è¯¯', {
                        timeOut: 5e3,
                        positionClass: 'toast-top-right'
                    }) : console.error(e)
                }
                var e
            }
            function w() {
                try {
                    console.log('å¼‚ä¸–ç•Œå’Œå¹³ç•Œé¢å¼€å§‹å¸è½½...'),
                    y && (y.cleanup(),
                    y.destroy().catch(console.error),
                    y = null),
                    f && (f.destroy(),
                    f = null),
                    v && (v.destroy(),
                    v = null),
                    p = null,
                    function() {
                        window.gameMessageInterval && (clearInterval(window.gameMessageInterval),
                        delete window.gameMessageInterval);
                        D(),
                        $(window).off('pagehide.gameApp'),
                        $(document).off('click.gameApp')
                    }(),
                    console.log('å¼‚ä¸–ç•Œå’Œå¹³ç•Œé¢å¸è½½å®Œæˆ')
                } catch (e) {
                    console.error('å¼‚ä¸–ç•Œå’Œå¹³ç•Œé¢å¸è½½æ—¶å‡ºé”™:', e)
                }
            }
            function M() {
                !function() {
                    try {
                        console.log('ğŸ« å¼€å§‹å¯ç”¨è§’è‰²ç«‹ç»˜å‘¼å¸æ•ˆæœ...'),
                        A(),
                        function() {
                            if ('undefined' == typeof MutationObserver)
                                return void console.warn('âš ï¸ æµè§ˆå™¨ä¸æ”¯æŒMutationObserverï¼Œæ— æ³•è‡ªåŠ¨ä¸ºæ–°å¢è§’è‰²æ·»åŠ å‘¼å¸æ•ˆæœ');
                            const e = new MutationObserver(e => {
                                let t = !1;
                                e.forEach(e => {
                                    e.addedNodes.forEach(e => {
                                        if (e.nodeType === Node.ELEMENT_NODE) {
                                            const a = e;
                                            a.classList && a.classList.contains('character-sprite') && a.classList.contains('dynamic') && (t = !0);
                                            $(a).find('.character-sprite.dynamic').length > 0 && (t = !0)
                                        }
                                    }
                                    )
                                }
                                ),
                                t && setTimeout( () => {
                                    (function() {
                                        try {
                                            const e = localStorage.getItem('iswp_breathing');
                                            if (null !== e)
                                                return 'true' === e;
                                            const t = document.cookie.match(/(?:^|; )iswp_breathing=([^;]+)/);
                                            if (t)
                                                return 'true' === t[1]
                                        } catch (e) {
                                            console.warn('æ— æ³•è¯»å–å‘¼å¸æ•ˆæœè®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼', e)
                                        }
                                        return !0
                                    }
                                    )() && A()
                                }
                                , 100)
                            }
                            );
                            e.observe(document.body, {
                                childList: !0,
                                subtree: !0
                            }),
                            window.characterBreathingObserver = e,
                            console.log('ğŸ‘€ å·²è®¾ç½®è§’è‰²ç«‹ç»˜è§‚å¯Ÿå™¨ï¼Œå°†è‡ªåŠ¨ä¸ºæ–°å¢è§’è‰²æ·»åŠ å‘¼å¸æ•ˆæœ')
                        }(),
                        console.log('âœ… è§’è‰²ç«‹ç»˜å‘¼å¸æ•ˆæœå·²å¯ç”¨')
                    } catch (e) {
                        console.error('âŒ å¯ç”¨è§’è‰²ç«‹ç»˜å‘¼å¸æ•ˆæœå¤±è´¥:', e)
                    }
                }(),
                console.log('âœ… å·²å¯ç”¨è§’è‰²ç«‹ç»˜å‘¼å¸æ•ˆæœ')
            }
            function I() {
                $('.character-sprite.dynamic').removeClass('breathing-natural breathing-sway breathing-pulse breathing-rhythmic'),
                D(),
                console.log('ğŸš« å·²ç¦ç”¨æ‰€æœ‰è§’è‰²ç«‹ç»˜å‘¼å¸æ•ˆæœ')
            }
            function k() {
                return {
                    gameDataManager: p,
                    uiController: v,
                    eventHandler: f,
                    llmrpParser: y
                }
            }
            function S() {
                v && v.updateUI()
            }
            function x() {
                console.log('æ¸¸æˆçŠ¶æ€å·²ä¿å­˜')
            }
            function A() {
                const e = $('.character-sprite.dynamic');
                console.log(`ğŸ­ æ‰¾åˆ° ${e.length} ä¸ªè§’è‰²ç«‹ç»˜`),
                e.each(function() {
                    const e = $(this);
                    e.hasClass('breathing-natural') || (e.addClass('breathing-natural'),
                    console.log('ğŸ« å·²ä¸ºè§’è‰²ç«‹ç»˜æ·»åŠ è‡ªç„¶çœŸå®å‘¼å¸æ•ˆæœ:', e.attr('class')))
                })
            }
            function D() {
                window.characterBreathingObserver && (window.characterBreathingObserver.disconnect(),
                delete window.characterBreathingObserver,
                console.log('ğŸ§¹ å·²æ¸…ç†è§’è‰²ç«‹ç»˜å‘¼å¸æ•ˆæœè§‚å¯Ÿå™¨'))
            }
        }
    }
      , t = {};
    function a(n) {
        var s = t[n];
        if (void 0 !== s)
            return s.exports;
        var i = t[n] = {
            exports: {}
        };
        return e[n](i, i.exports, a),
        i.exports
    }
    a.n = e => {
        var t = e && e.__esModule ? () => e.default : () => e;
        return a.d(t, {
            a: t
        }),
        t
    }
    ,
    a.d = (e, t) => {
        for (var n in t)
            a.o(t, n) && !a.o(e, n) && Object.defineProperty(e, n, {
                    enumerable: !0,
                    get: t[n]
                })
    }
    ,
    a.o = (e, t) => Object.prototype.hasOwnProperty.call(e, t),
    a.r = e => {
        'undefined' != typeof Symbol && Symbol.toStringTag && Object.defineProperty(e, Symbol.toStringTag, {
            value: 'Module'
        }),
        Object.defineProperty(e, '__esModule', {
            value: !0
        })
    }
    ;
    var n = a(387);
    $( () => {
        (0,
        n.onLoad)()
    }
    ),
    $(window).on('pagehide', () => {
        (0,
        n.onUnload)()
    }
    );
</script>
<style>
        :root {
            --bg-gradient: #6262629e;
            --text-color: #f5f5f7;
            --primary-color: #0a84ff;
            --primary-color-light: rgba(10,132,255,0.2);
            --primary-color-lighter: rgba(10,132,255,0.3);
            --ui-bg: rgba(29,29,31,0.7);
            --ui-bg-heavy: rgba(29,29,31,0.85);
            --ui-border-color: rgba(255,255,255,0.1);
            --shadow-color-light: rgba(0,0,0,0.2);
            --shadow-color-medium: rgba(0,0,0,0.3);
            --blur-intensity: 20px;
            --gold-color: #ffd700
        }

        [data-theme=light] {
            --bg-gradient: #6262629e;
            --text-color: #1d1d1f;
            --primary-color: #007aff;
            --primary-color-light: rgba(0,122,255,0.1);
            --primary-color-lighter: rgba(0,122,255,0.2);
            --ui-bg: rgba(255,255,255,0.8);
            --ui-bg-heavy: rgba(255,255,255,0.95);
            --ui-border-color: rgba(0,0,0,0.1);
            --shadow-color-light: rgba(0,0,0,0.1);
            --shadow-color-medium: rgba(0,0,0,0.15);
            --blur-intensity: 20px;
            --gold-color: #d4af37
        }

        [data-theme=light] * {
            color: var(--text-color) !important
        }

        [data-theme=dark] {
            --bg-gradient: #6262629e;
            --text-color: #f5f5f7;
            --primary-color: #0a84ff;
            --primary-color-light: rgba(10,132,255,0.2);
            --primary-color-lighter: rgba(10,132,255,0.3);
            --ui-bg: rgba(29,29,31,0.7);
            --ui-bg-heavy: rgba(29,29,31,0.85);
            --ui-border-color: rgba(255,255,255,0.1);
            --shadow-color-light: rgba(0,0,0,0.2);
            --shadow-color-medium: rgba(0,0,0,0.3);
            --blur-intensity: 20px;
            --gold-color: #ffd700
        }

        [data-theme=glass] {
            --bg-gradient: #6262629e;
            --text-color: #1d1d1f;
            --primary-color: #007aff;
            --primary-color-light: rgba(0,122,255,0.1);
            --primary-color-lighter: rgba(0,122,255,0.2);
            --ui-bg: rgba(255,255,255,0.3);
            --ui-bg-heavy: rgba(255,255,255,0.4);
            --ui-border-color: rgba(0,0,0,0.1);
            --shadow-color-light: rgba(0,0,0,0.1);
            --shadow-color-medium: rgba(0,0,0,0.15);
            --blur-intensity: 30px;
            --gold-color: #d4af37
        }

        [data-theme=glass] * {
            color: var(--text-color) !important
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
            background: var(--bg-gradient);
            color: var(--text-color);
            overflow: hidden;
            width: 100%;
            aspect-ratio: 16/9;
            transition: background .5s ease,color .5s ease
        }

        body[data-theme=dark] {
            --bg-gradient: #6262629e;
            --text-color: #f5f5f7;
            --primary-color: #0a84ff;
            --primary-color-light: rgba(10,132,255,0.2);
            --primary-color-lighter: rgba(10,132,255,0.3);
            --ui-bg: rgba(29,29,31,0.7);
            --ui-bg-heavy: rgba(29,29,31,0.85);
            --ui-border-color: rgba(255,255,255,0.1);
            --gold-color: #ffd700
        }

        body[data-theme=glass] {
            --ui-bg: rgba(255,255,255,0.3);
            --ui-bg-heavy: rgba(255,255,255,0.4);
            --blur-intensity: 30px
        }

        #app-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            position: relative
        }

        #app-container.modal-active>#content-area {
            filter: blur(4px);
            transform: scale(0.98);
            transition: all .4s cubic-bezier(0.25,0.46,0.45,0.94)
        }

        .top-header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            width: 100%;
            gap: 20px;
            pointer-events: auto
        }

        #main-nav {
            display: flex;
            align-items: center;
            gap: 8px
        }

        .nav-btn {
            display: flex;
            align-items: center;
            padding: 4px;
            margin: 0;
            background: var(--ui-bg);
            border: 1px solid rgba(0,0,0,0);
            border-radius: 20px;
            cursor: pointer;
            transition: all .4s cubic-bezier(0.25,0.46,0.45,0.94);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px var(--shadow-color-light)
        }

        .nav-btn:hover {
            background: var(--primary-color-light);
            border-color: var(--primary-color-lighter)
        }

        .nav-btn.active {
            background: var(--primary-color)
        }

        .nav-icon {
            width: 32px;
            height: 32px;
            background: rgba(0,0,0,0);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: none;
            transition: all .4s ease
        }

        .nav-icon i {
            font-size: 16px;
            color: var(--text-color);
            transition: color .5s ease
        }

        .nav-btn.active .nav-icon i {
            color: #fff
        }

        .nav-text {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-color);
            white-space: nowrap;
            max-width: 0;
            opacity: 0;
            overflow: hidden;
            transition: all .4s cubic-bezier(0.25,0.46,0.45,0.94);
            margin-left: 0
        }

        .nav-btn:hover .nav-text,.nav-btn.active .nav-text {
            max-width: 60px;
            opacity: 1;
            margin-left: 8px;
            margin-right: 8px
        }

        .nav-btn.active .nav-text {
            color: #fff
        }

        .nav-btn.disabled,.nav-btn:disabled {
            opacity: .5;
            cursor: not-allowed;
            pointer-events: none
        }

        .nav-btn.disabled:hover,.nav-btn:disabled:hover {
            background: var(--ui-bg);
            border-color: var(--ui-border-color)
        }

        .nav-btn.disabled .nav-text,.nav-btn:disabled .nav-text {
            max-width: 0;
            opacity: 0;
            margin-left: 0;
            margin-right: 0
        }

        .nav-btn.active {
            background: var(--primary-color)
        }

        .nav-btn.active .nav-icon i {
            color: #fff
        }

        .nav-btn.active .nav-text {
            color: #fff
        }

        .nav-btn:hover .nav-text,.nav-btn.active .nav-text {
            max-width: 60px;
            opacity: 1;
            margin-left: 8px;
            margin-right: 8px
        }

        @media (max-width: 768px) {
            .nav-text {
                display:none
            }

            .nav-icon {
                margin-right: 0
            }

            .nav-btn {
                min-width: 36px;
                height: 36px;
                padding: 2px
            }
        }

        #content-area {
            flex: 1;
            position: relative;
            overflow: hidden;
            transition: all .4s cubic-bezier(0.25,0.46,0.45,0.94)
        }

        .modal-view-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity .4s,visibility .4s;
            background-color: rgba(0,0,0,.3)
        }

        .modal-view-container.active {
            opacity: 1;
            visibility: visible
        }

        .modal-content {
            width: 90%;
            max-width: 1200px;
            height: 85%;
            max-height: 800px;
            background: var(--ui-bg-heavy);
            backdrop-filter: blur(var(--blur-intensity));
            -webkit-backdrop-filter: blur(var(--blur-intensity));
            border-radius: 24px;
            box-shadow: 0 16px 64px var(--shadow-color-medium);
            border: 1px solid var(--ui-border-color);
            transform: scale(0.95);
            transition: transform .4s cubic-bezier(0.25,0.46,0.45,0.94),background-color .5s ease,border-color .5s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden
        }

        .modal-view-container.active .modal-content {
            transform: scale(1)
        }

        .modal-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 30px;
            height: 30px;
            background: rgba(0,0,0,.1);
            border: none;
            border-radius: 50%;
            color: var(--text-color);
            cursor: pointer;
            font-size: 16px;
            z-index: 110;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all .3s ease
        }

        .modal-close-btn:hover {
            background: rgba(0,0,0,.2);
            transform: rotate(90deg)
        }

        .character-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding-bottom: 50px
        }

        .cg-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 4;
            opacity: 0;
            visibility: hidden;
            transition: opacity .3s ease,visibility .3s ease;
            pointer-events: none
        }

        .cg-layer .cg-image {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%,-50%) scale(0.85);
            max-width: min(92%,1200px);
            max-height: 82%;
            width: auto;
            height: auto;
            object-fit: contain;
            border-radius: 20px;
            background: var(--ui-bg-heavy);
            border: 1px solid var(--ui-border-color);
            box-shadow: 0 2px 8px var(--shadow-color-light);
            filter: blur(8px);
            transition: transform 600ms cubic-bezier(0.25,0.46,0.45,0.94),filter 400ms ease-out,box-shadow 200ms ease;
            pointer-events: auto;
            cursor: pointer;
            will-change: transform,filter
        }

        .cg-layer .cg-image:hover {
            box-shadow: 0 4px 16px var(--shadow-color-light);
            filter: brightness(105%);
            transform: translate(-50%,-50%) scale(0.87)
        }

        .cg-layer .cg-image:active {
            transform: translate(-50%,-50%) scale(0.83)
        }

        .cg-layer.active {
            opacity: 1;
            visibility: visible
        }

        .cg-layer.active .cg-image {
            transform: translate(-50%,-50%) scale(1);
            filter: blur(0)
        }

        .character-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            width: 100%;
            height: 120%;
            min-height: 400px;
            margin-top: 0%
        }

        #character-sprite.character-sprite,.character-sprite.old-sprite,#character-left,#character-right {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important
        }

        .character-sprite {
            position: absolute;
            bottom: -50%;
            height: 100%;
            width: auto;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3));
            pointer-events: auto
        }

        .character-sprite.dynamic {
            transition: all .4s cubic-bezier(0.4,0,0.2,1);
            transform-origin: bottom center
        }

        .character-sprite.dynamic.pos-left {
            left: 25%;
            z-index: 3;
            transform: translateX(-50%) translateY(-30%)
        }

        .character-sprite.dynamic.pos-center {
            left: 50%;
            z-index: 4;
            transform: translateX(-50%) translateY(-30%)
        }

        .character-sprite.dynamic.pos-right {
            left: 75%;
            z-index: 3;
            transform: translateX(-50%) translateY(-30%)
        }

        .character-sprite.dynamic.pos-three-left {
            left: 15%;
            z-index: 3;
            transform: translateX(-50%) translateY(-30%)
        }

        .character-sprite.dynamic.pos-three-center {
            left: 50%;
            z-index: 4;
            transform: translateX(-50%) translateY(-30%)
        }

        .character-sprite.dynamic.pos-three-right {
            left: 85%;
            z-index: 3;
            transform: translateX(-50%) translateY(-30%)
        }

        .character-sprite.dynamic.entering {
            opacity: 0
        }

        .character-sprite.dynamic.entering.pos-left {
            transform: translateX(-50%) translateY(50px);
            animation: enterFromBottomCenter .6s ease-out forwards
        }

        .character-sprite.dynamic.entering.pos-center {
            transform: translateX(-50%) translateY(50px);
            animation: enterFromBottomCenter .6s ease-out forwards
        }

        .character-sprite.dynamic.entering.pos-right {
            transform: translateX(-50%) translateY(50px);
            animation: enterFromBottomCenter .6s ease-out forwards
        }

        .character-sprite.dynamic.entering.pos-three-left {
            transform: translateX(-50%) translateY(50px);
            animation: enterFromBottomCenter .6s ease-out forwards
        }

        .character-sprite.dynamic.entering.pos-three-center {
            transform: translateX(-50%) translateY(50px);
            animation: enterFromBottomCenter .6s ease-out forwards
        }

        .character-sprite.dynamic.entering.pos-three-right {
            transform: translateX(-50%) translateY(50px);
            animation: enterFromBottomCenter .6s ease-out forwards
        }

        .character-sprite.dynamic.exiting {
            animation: fadeOut .4s ease-in forwards
        }

        .character-sprite.dynamic.sprite-changing {
            opacity: .3;
            transform: scale(0.98);
            transition: all .2s ease-out
        }

        .character-sprite.dynamic.dimmed {
            filter: brightness(0.5) grayscale(0.3);
            transition: filter .3s ease
        }

        .character-sprite:not(.dynamic) {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important
        }

        .character-sprite:not(.dynamic):not([src=""]):not([src="#"]) {
            display: none !important
        }

        @keyframes enterFromBottomCenter {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(50px)
            }

            to {
                opacity: 1;
                transform: translateX(-50%) translateY(-30%)
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1
            }

            to {
                opacity: 0
            }
        }

        .background-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            opacity: 0;
            z-index: 2;
            pointer-events: none;
            transition: opacity .5s ease
        }

        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--ui-bg);
            backdrop-filter: blur(var(--blur-intensity));
            -webkit-backdrop-filter: blur(var(--blur-intensity));
            padding: 12px 20px;
            border-radius: 16px;
            box-shadow: 0 4px 16px var(--shadow-color-light);
            transition: background-color .5s ease;
            flex-grow: 1
        }

        .game-info {
            display: flex;
            align-items: center;
            gap: 20px
        }

        .money-display {
            display: flex;
            align-items: center;
            gap: 20px;
            font-weight: 500;
            color: var(--text-color)
        }

        .money-item {
            display: flex;
            align-items: center;
            gap: 8px
        }

        .game-date,.player-status,.game-location,.game-time-period {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            color: var(--text-color)
        }

        .dialogue-box {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 40px);
            max-width: 1000px;
            z-index: 5;
            background: var(--ui-bg-heavy);
            backdrop-filter: blur(var(--blur-intensity));
            -webkit-backdrop-filter: blur(var(--blur-intensity));
            border-radius: 20px;
            padding: 24px;
            transition: background-color .5s ease,border-color .5s ease;
            box-shadow: 0 8px 32px var(--shadow-color-medium);
            border: 1px solid var(--ui-border-color);
            pointer-events: auto
        }

        .character-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary-color-light)
        }

        .dialogue-text {
            font-size: 16px;
            line-height: 1.6;
            color: var(--text-color);
            margin-bottom: 16px
        }

        .dialogue-controls {
            display: flex;
            gap: 12px;
            flex-shrink: 0;
            margin-left: auto
        }

        .control-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: rgba(0,0,0,0);
            color: var(--text-color);
            cursor: pointer;
            transition: all .3s ease;
            display: flex;
            align-items: center;
            justify-content: center
        }

        .control-btn:hover {
            color: var(--primary-color);
            transform: scale(1.2)
        }

        .control-btn:active {
            transform: scale(1)
        }

        .control-btn.disabled,.control-btn:disabled {
            color: var(--text-color-secondary);
            cursor: not-allowed;
            opacity: .5
        }

        .control-btn.disabled:hover,.control-btn:disabled:hover {
            color: var(--text-color-secondary);
            transform: none
        }

        .control-btn i {
            font-size: 18px
        }

        .character-hover-trigger {
            display: none
        }

        .character-status-tooltip {
            position: absolute;
            left: 25%;
            top: 45%;
            transform: translate(-50%,-50%);
            width: -moz-fit-content;
            width: fit-content;
            min-width: 200px;
            max-width: min(320px,100vw - 40px);
            padding: 18px;
            background: var(--ui-bg);
            backdrop-filter: blur(var(--blur-intensity));
            -webkit-backdrop-filter: blur(var(--blur-intensity));
            border-radius: 20px;
            box-shadow: 0 8px 32px var(--shadow-color-medium);
            border: 1px solid var(--ui-border-color);
            opacity: 0;
            visibility: hidden;
            z-index: 15;
            pointer-events: none;
            transition: all .4s cubic-bezier(0.25,0.46,0.45,0.94);
            text-align: left
        }

        @media (max-width: 768px) {
            .character-status-tooltip {
                left:50%;
                min-width: 180px;
                max-width: calc(100vw - 40px);
                padding: 14px;
                font-size: 14px
            }
        }

        .character-hover-trigger:hover~.character-status-tooltip,.character-sprite:hover~.character-status-tooltip {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%,-50%)
        }

        .character-status-tooltip.active {
            opacity: 1;
            visibility: visible
        }

        .status-tooltip-header {
            text-align: left;
            padding-bottom: 12px
        }

        .character-fullname {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-color);
            margin: 0
        }

        @media (max-width: 768px) {
            .character-fullname {
                font-size:18px
            }
        }

        .character-affiliation {
            font-size: 14px;
            color: var(--text-color);
            opacity: .8;
            font-weight: 500;
            margin: 4px 0 0 0
        }

        @media (max-width: 768px) {
            .character-affiliation {
                font-size:12px
            }
        }

        .status-tooltip-divider {
            height: 1px;
            background: var(--ui-border-color);
            margin: 0
        }

        .status-tooltip-body {
            padding: 12px 0;
            display: flex;
            flex-direction: column;
            gap: 8px
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            align-items: center;
            min-width: 0;
            gap: 8px
        }

        .status-label {
            color: var(--text-color);
            opacity: .8;
            font-weight: 500;
            min-width: 50px;
            flex-shrink: 0
        }

        .status-value {
            color: var(--text-color);
            font-weight: 600;
            text-align: right;
            min-width: 0
        }

        .status-value.relationship {
            color: var(--text-color);
            font-weight: 600
        }

        .status-progress-bar {
            width: 80px;
            height: 8px;
            background-color: rgba(120,120,128,.2);
            border-radius: 4px;
            overflow: hidden;
            align-self: baseline;
            flex-shrink: 0
        }

        .progress-bar-fill {
            height: 100%;
            background-color: var(--primary-color);
            border-radius: 4px;
            transition: width .5s ease-in-out
        }

        .status-tooltip-footer {
            padding-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px
        }

        .status-tooltip-footer .status-value {
            font-variant-emoji: text
        }

        .status-tooltip-footer .status-value[data-emoji=true] {
            position: relative
        }

        .status-tooltip-footer .status-value[data-emoji=true]::before {
            content: "â€¢";
            color: var(--text-color);
            opacity: .6;
            margin-right: 6px;
            font-weight: 400
        }

        .status-tags-container {
            display: flex;
            align-items: flex-start;
            gap: 8px
        }

        .status-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            justify-content: flex-start
        }

        .status-tag {
            background: var(--primary-color);
            color: #fff;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 8px;
            font-weight: 500;
            text-align: center;
            white-space: nowrap;
            display: inline-block;
            width: auto
        }

        @media (max-width: 768px) {
            .status-tag {
                font-size:11px;
                padding: 3px 6px
            }
        }

        .settings-popover {
            position: absolute;
            top: 60px;
            right: 20px;
            background: var(--ui-bg-heavy);
            backdrop-filter: blur(var(--blur-intensity));
            -webkit-backdrop-filter: blur(var(--blur-intensity));
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px var(--shadow-color-medium);
            border: 1px solid var(--ui-border-color);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px) scale(0.95);
            transition: all .3s cubic-bezier(0.25,0.46,0.45,0.94);
            z-index: 1000;
            min-width: 200px;
            max-width: calc(100vw - 40px);
            max-height: calc(100vh - 100px);
            overflow-y: auto
        }

        .settings-popover::-webkit-scrollbar {
            display: none
        }

        .settings-popover {
            scrollbar-width: none;
            -ms-overflow-style: none
        }

        .settings-popover.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1)
        }

        @media (max-width: 768px) {
            .settings-popover {
                position:fixed;
                top: 50%;
                left: 50%;
                right: auto;
                transform: translate(-50%,-50%) scale(0.95);
                width: calc(100vw - 40px);
                max-width: 400px;
                max-height: calc(100vh - 80px)
            }

            .settings-popover.active {
                transform: translate(-50%,-50%) scale(1)
            }
        }

        @media (max-width: 480px) {
            .settings-popover {
                width:calc(100vw - 20px);
                padding: 16px;
                border-radius: 12px;
                max-height: calc(100vh - 60px)
            }
        }

        .settings-section {
            margin-bottom: 16px
        }

        .settings-section:last-child {
            margin-bottom: 0
        }

        .settings-section label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 8px
        }

        .theme-buttons-container {
            display: flex;
            gap: 8px
        }

        .theme-btn {
            width: 40px;
            height: 40px;
            border: 2px solid var(--ui-border-color);
            border-radius: 50%;
            background: var(--ui-bg);
            color: var(--text-color);
            cursor: pointer;
            transition: all .3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px
        }

        .theme-btn:hover {
            border-color: var(--primary-color);
            transform: scale(1.1)
        }

        .theme-btn.active {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: #fff
        }

        .visual-effects-section .section-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px
        }

        .visual-effects-section .section-header i {
            color: var(--primary-color);
            font-size: 14px
        }

        .visual-effects-section .section-header .section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
            margin: 0
        }

        .visual-effects-section .settings-options {
            display: flex;
            flex-direction: column;
            gap: 12px
        }

        .visual-effects-section .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: var(--ui-bg);
            border: 1px solid var(--ui-border-color);
            border-radius: 8px;
            transition: all .3s ease
        }

        .visual-effects-section .setting-item:hover:not(.disabled) {
            background: var(--ui-bg-light);
            border-color: var(--primary-color-light)
        }

        .visual-effects-section .setting-item.disabled {
            opacity: .5;
            cursor: not-allowed
        }

        @media (max-width: 480px) {
            .visual-effects-section .setting-item {
                flex-direction:column;
                align-items: flex-start;
                gap: 8px;
                padding: 10px
            }

            .visual-effects-section .setting-item .setting-control {
                width: 100%;
                display: flex;
                justify-content: flex-end
            }
        }

        .visual-effects-section .setting-item .setting-info {
            flex: 1
        }

        .visual-effects-section .setting-item .setting-info .setting-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-color);
            margin-bottom: 2px
        }

        .visual-effects-section .setting-item .setting-info .setting-description {
            font-size: 11px;
            color: var(--text-color);
            opacity: .7;
            line-height: 1.3
        }

        .visual-effects-section .setting-item .setting-control .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: var(--ui-bg-heavy);
            border: 1px solid var(--ui-border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all .3s ease
        }

        .visual-effects-section .setting-item .setting-control .toggle-switch::before {
            content: "";
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: var(--text-color);
            border-radius: 50%;
            transition: all .3s ease;
            opacity: .6
        }

        .visual-effects-section .setting-item .setting-control .toggle-switch.active {
            background: var(--primary-color);
            border-color: var(--primary-color)
        }

        .visual-effects-section .setting-item .setting-control .toggle-switch.active::before {
            left: 22px;
            background: #fff;
            opacity: 1
        }

        .visual-effects-section .setting-item .setting-control .modern-toggle {
            position: relative;
            display: flex;
            align-items: center;
            cursor: pointer;
            -webkit-user-select: none;
            user-select: none
        }

        .visual-effects-section .setting-item .setting-control .modern-toggle input[type=checkbox] {
            display: none
        }

        .visual-effects-section .setting-item .setting-control .modern-toggle .toggle-track {
            position: relative;
            width: 52px;
            height: 28px;
            background: var(--ui-bg-heavy);
            border: 2px solid var(--ui-border-color);
            border-radius: 14px;
            transition: all .3s cubic-bezier(0.4,0,0.2,1);
            cursor: pointer
        }

        .visual-effects-section .setting-item .setting-control .modern-toggle .toggle-track .toggle-thumb {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: var(--text-color);
            border-radius: 50%;
            transition: all .3s cubic-bezier(0.4,0,0.2,1);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,.1)
        }

        .visual-effects-section .setting-item .setting-control .modern-toggle .toggle-track .toggle-thumb .toggle-icon {
            font-size: 10px;
            color: var(--ui-bg-heavy);
            opacity: 0;
            transition: opacity .2s ease
        }

        .visual-effects-section .setting-item .setting-control .modern-toggle input[type=checkbox]:checked+.toggle-track {
            background: var(--primary-color);
            border-color: var(--primary-color)
        }

        .visual-effects-section .setting-item .setting-control .modern-toggle input[type=checkbox]:checked+.toggle-track .toggle-thumb {
            left: 26px;
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,.2)
        }

        .visual-effects-section .setting-item .setting-control .modern-toggle input[type=checkbox]:checked+.toggle-track .toggle-thumb .toggle-icon {
            opacity: 1;
            color: var(--primary-color)
        }

        .visual-effects-section .setting-item .setting-control .modern-toggle.disabled {
            opacity: .5;
            cursor: not-allowed
        }

        .visual-effects-section .setting-item .setting-control .modern-toggle.disabled .toggle-track {
            cursor: not-allowed
        }

        .visual-effects-section .setting-item .setting-control .modern-toggle:not(.disabled):hover .toggle-track {
            box-shadow: 0 0 0 4px rgba(var(--primary-color-rgb),0.1)
        }

        .visual-effects-section .setting-item .setting-control input[type=checkbox] {
            display: none
        }

        .modern-select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid var(--border-color,#333);
            border-radius: 8px;
            background: var(--input-bg,#2a2a2a);
            color: var(--text-color,#f5f5f7);
            font-size: 14px;
            font-family: inherit;
            cursor: pointer;
            transition: all .3s ease;
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23f5f5f7' stroke-width='2'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
            padding-right: 36px
        }

        .modern-select:hover {
            border-color: var(--accent-color,#007aff);
            background-color: var(--input-hover-bg,#333)
        }

        .modern-select:focus {
            outline: none;
            border-color: var(--accent-color,#007aff);
            box-shadow: 0 0 0 2px rgba(0,122,255,.2)
        }

        .modern-select option {
            background: var(--input-bg,#2a2a2a);
            color: var(--text-color,#f5f5f7);
            padding: 8px
        }

        .slider-container {
            width: 100%
        }

        .slider-container .modern-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--slider-track-bg,#333);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
            transition: all .3s ease
        }

        .slider-container .modern-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent-color,#007aff);
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 2px 6px rgba(0,0,0,.2);
            -webkit-transition: all .3s ease;
            transition: all .3s ease
        }

        .slider-container .modern-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,122,255,.3)
        }

        .slider-container .modern-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent-color,#007aff);
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 2px 6px rgba(0,0,0,.2);
            -moz-transition: all .3s ease;
            transition: all .3s ease
        }

        .slider-container .modern-slider::-moz-range-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,122,255,.3)
        }

        .slider-container .modern-slider::-webkit-slider-track {
            height: 6px;
            border-radius: 3px;
            background: var(--slider-track-bg,#333)
        }

        .slider-container .modern-slider::-moz-range-track {
            height: 6px;
            border-radius: 3px;
            background: var(--slider-track-bg,#333);
            border: none
        }

        .slider-container .slider-labels {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            font-size: 12px;
            color: var(--text-secondary,#888)
        }

        .slider-container .slider-labels span:nth-child(2) {
            font-weight: 600;
            color: var(--accent-color,#007aff);
            background: var(--accent-bg,rgba(0,122,255,0.1));
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px
        }

        [data-theme=light] .modern-select {
            --input-bg: #f8f9fa;
            --input-hover-bg: #e9ecef;
            --border-color: #dee2e6;
            --text-color: #212529;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23212529' stroke-width='2'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e")
        }

        [data-theme=light] .modern-select option {
            background: #f8f9fa;
            color: #212529
        }

        [data-theme=light] .modern-slider {
            --slider-track-bg: #dee2e6
        }

        [data-theme=glass] .modern-select {
            --input-bg: rgba(255,255,255,0.1);
            --input-hover-bg: rgba(255,255,255,0.15);
            --border-color: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px)
        }

        [data-theme=glass] .modern-select option {
            background: rgba(0,0,0,.8);
            backdrop-filter: blur(10px)
        }

        [data-theme=glass] .modern-slider {
            --slider-track-bg: rgba(255,255,255,0.2)
        }

        .reset-setting-item {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 8px 0
        }

        .reset-setting-item .setting-control {
            width: 100%;
            display: flex;
            justify-content: center
        }

        .reset-btn {
            background: linear-gradient(135deg,var(--accent-color),var(--accent-color-dark));
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all .3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,.1);
            min-width: 100px
        }

        .reset-btn:hover {
            background: linear-gradient(135deg,var(--accent-color-dark),var(--accent-color));
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,.15)
        }

        .reset-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(0,0,0,.1)
        }

        .reset-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(var(--accent-color-rgb),0.3)
        }

        .dialogue-bottom-controls {
            display: flex;
            align-items: center;
            margin-top: 16px;
            gap: 16px
        }

        .player-choice-input {
            flex: 1
        }

        .player-choice-input .choice-input-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            background: var(--ui-bg);
            border: 1px solid var(--ui-border-color);
            border-radius: 6px;
            padding: 8px 12px
        }

        .player-choice-input .choice-input-controls .choice-input-icon {
            color: #fff;
            font-size: 14px;
            flex-shrink: 0
        }

        .player-choice-input .choice-input-controls #choice-text-input {
            flex-grow: 1;
            padding: 6px 8px;
            border: none;
            background: rgba(0,0,0,0);
            color: var(--text-color);
            font-size: 14px;
            outline: none
        }

        .player-choice-input .choice-input-controls #choice-text-input::placeholder {
            color: var(--text-color-secondary);
            opacity: .7
        }

        .player-choice-input .choice-input-controls .choice-add-btn {
            width: 32px;
            height: 32px;
            background: rgba(0,0,0,0);
            color: var(--text-color);
            border: none;
            cursor: pointer;
            transition: all .3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0
        }

        .player-choice-input .choice-input-controls .choice-add-btn:hover {
            color: var(--primary-color);
            transform: scale(1.2)
        }

        .player-choice-input .choice-input-controls .choice-add-btn:active {
            transform: scale(1)
        }

        .player-choice-input .choice-input-controls .choice-add-btn.clicked {
            color: #34d399;
            transform: scale(1.1)
        }

        .player-choice-input .choice-input-controls .choice-add-btn i {
            font-size: 16px
        }

        .character-sprite.dynamic.character-shake.pos-left {
            animation: characterShakeLeft .6s ease-in-out !important
        }

        .character-sprite.dynamic.character-shake.pos-center {
            animation: characterShakeCenter .6s ease-in-out !important
        }

        .character-sprite.dynamic.character-shake.pos-right {
            animation: characterShakeRight .6s ease-in-out
        }

        .character-sprite.dynamic.character-shake.pos-three-left {
            animation: characterShakeThreeLeft .6s ease-in-out
        }

        .character-sprite.dynamic.character-shake.pos-three-center {
            animation: characterShakeThreeCenter .6s ease-in-out
        }

        .character-sprite.dynamic.character-shake.pos-three-right {
            animation: characterShakeThreeRight .6s ease-in-out
        }

        @keyframes characterShakeLeft {
            0%,100% {
                transform: translateX(-50%) translateY(-30%)
            }

            10%,30%,50%,70%,90% {
                transform: translateX(-50%) translateY(-30%) translateX(-5px)
            }

            20%,40%,60%,80% {
                transform: translateX(-50%) translateY(-30%) translateX(5px)
            }
        }

        @keyframes characterShakeCenter {
            0%,100% {
                transform: translateX(-50%) translateY(-30%)
            }

            10%,30%,50%,70%,90% {
                transform: translateX(-50%) translateY(-30%) translateX(-5px)
            }

            20%,40%,60%,80% {
                transform: translateX(-50%) translateY(-30%) translateX(5px)
            }
        }

        @keyframes characterShakeRight {
            0%,100% {
                transform: translateX(-50%) translateY(-30%)
            }

            10%,30%,50%,70%,90% {
                transform: translateX(-50%) translateY(-30%) translateX(-5px)
            }

            20%,40%,60%,80% {
                transform: translateX(-50%) translateY(-30%) translateX(5px)
            }
        }

        @keyframes characterShakeThreeLeft {
            0%,100% {
                transform: translateX(-50%) translateY(-30%)
            }

            10%,30%,50%,70%,90% {
                transform: translateX(-50%) translateY(-30%) translateX(-5px)
            }

            20%,40%,60%,80% {
                transform: translateX(-50%) translateY(-30%) translateX(5px)
            }
        }

        @keyframes characterShakeThreeCenter {
            0%,100% {
                transform: translateX(-50%) translateY(-30%)
            }

            10%,30%,50%,70%,90% {
                transform: translateX(-50%) translateY(-30%) translateX(-5px)
            }

            20%,40%,60%,80% {
                transform: translateX(-50%) translateY(-30%) translateX(5px)
            }
        }

        @keyframes characterShakeThreeRight {
            0%,100% {
                transform: translateX(-50%) translateY(-30%)
            }

            10%,30%,50%,70%,90% {
                transform: translateX(-50%) translateY(-30%) translateX(-5px)
            }

            20%,40%,60%,80% {
                transform: translateX(-50%) translateY(-30%) translateX(5px)
            }
        }

        .character-sprite.dynamic.character-jump-up.pos-left,.character-sprite.dynamic.character-jump-up.pos-center,.character-sprite.dynamic.character-jump-up.pos-right,.character-sprite.dynamic.character-jump-up.pos-three-left,.character-sprite.dynamic.character-jump-up.pos-three-center,.character-sprite.dynamic.character-jump-up.pos-three-right {
            animation: characterJumpUp .4s ease-out
        }

        @keyframes characterJumpUp {
            0% {
                transform: translateX(-50%) translateY(-30%)
            }

            50% {
                transform: translateX(-50%) translateY(-30%) translateY(-25px)
            }

            100% {
                transform: translateX(-50%) translateY(-30%)
            }
        }

        .character-sprite.dynamic.character-jump-down.pos-left,.character-sprite.dynamic.character-jump-down.pos-center,.character-sprite.dynamic.character-jump-down.pos-right,.character-sprite.dynamic.character-jump-down.pos-three-left,.character-sprite.dynamic.character-jump-down.pos-three-center,.character-sprite.dynamic.character-jump-down.pos-three-right {
            animation: characterJumpDown .4s ease-out
        }

        @keyframes characterJumpDown {
            0% {
                transform: translateX(-50%) translateY(-30%)
            }

            50% {
                transform: translateX(-50%) translateY(-30%) translateY(15px)
            }

            100% {
                transform: translateX(-50%) translateY(-30%)
            }
        }

        .character-sprite.dynamic.character-tilt.pos-left,.character-sprite.dynamic.character-tilt.pos-center,.character-sprite.dynamic.character-tilt.pos-right,.character-sprite.dynamic.character-tilt.pos-three-left,.character-sprite.dynamic.character-tilt.pos-three-center,.character-sprite.dynamic.character-tilt.pos-three-right {
            animation: characterTilt .8s ease-in-out
        }

        @keyframes characterTilt {
            0% {
                transform: translateX(-50%) translateY(-30%) rotate(0deg)
            }

            25% {
                transform: translateX(-50%) translateY(-30%) rotate(-4deg)
            }

            75% {
                transform: translateX(-50%) translateY(-30%) rotate(4deg)
            }

            100% {
                transform: translateX(-50%) translateY(-30%) rotate(0deg)
            }
        }

        .character-sprite.dynamic.character-shake,.character-sprite.dynamic.character-jump-up,.character-sprite.dynamic.character-jump-down,.character-sprite.dynamic.character-tilt {
            pointer-events: none;
            z-index: inherit
        }

        .character-sprite.dynamic.breathing-natural.pos-left,.character-sprite.dynamic.breathing-natural.pos-center,.character-sprite.dynamic.breathing-natural.pos-right,.character-sprite.dynamic.breathing-natural.pos-three-left,.character-sprite.dynamic.breathing-natural.pos-three-center,.character-sprite.dynamic.breathing-natural.pos-three-right {
            animation: naturalBreathing 4.2s cubic-bezier(0.4,0,0.6,1) infinite
        }

        .character-sprite.dynamic.breathing-sway.pos-left,.character-sprite.dynamic.breathing-sway.pos-center,.character-sprite.dynamic.breathing-sway.pos-right,.character-sprite.dynamic.breathing-sway.pos-three-left,.character-sprite.dynamic.breathing-sway.pos-three-center,.character-sprite.dynamic.breathing-sway.pos-three-right {
            animation: gentleSway 6.8s cubic-bezier(0.25,0.46,0.45,0.94) infinite
        }

        .character-sprite.dynamic.breathing-pulse.pos-left,.character-sprite.dynamic.breathing-pulse.pos-center,.character-sprite.dynamic.breathing-pulse.pos-right,.character-sprite.dynamic.breathing-pulse.pos-three-left,.character-sprite.dynamic.breathing-pulse.pos-three-center,.character-sprite.dynamic.breathing-pulse.pos-three-right {
            animation: vitalPulse 3.8s ease-in-out infinite
        }

        .character-sprite.dynamic.breathing-natural.pos-left,.character-sprite.dynamic.breathing-natural.pos-center,.character-sprite.dynamic.breathing-natural.pos-right,.character-sprite.dynamic.breathing-natural.pos-three-left,.character-sprite.dynamic.breathing-natural.pos-three-center,.character-sprite.dynamic.breathing-natural.pos-three-right {
            animation: naturalBreathingRealistic 4s ease-out infinite
        }

        .character-sprite.dynamic.breathing-rhythmic.pos-left,.character-sprite.dynamic.breathing-rhythmic.pos-center,.character-sprite.dynamic.breathing-rhythmic.pos-right,.character-sprite.dynamic.breathing-rhythmic.pos-three-left,.character-sprite.dynamic.breathing-rhythmic.pos-three-center,.character-sprite.dynamic.breathing-rhythmic.pos-three-right {
            animation: rhythmicBreathing 2.4s linear infinite
        }

        @keyframes naturalBreathing {
            0% {
                transform: translateX(-50%) translateY(-30%) scale(1)
            }

            25% {
                transform: translateX(-50%) translateY(calc(-30% - 1px)) scale(1.002)
            }

            35% {
                transform: translateX(-50%) translateY(calc(-30% - 1.2px)) scale(1.003)
            }

            75% {
                transform: translateX(-50%) translateY(calc(-30% + 0.8px)) scale(0.999)
            }

            100% {
                transform: translateX(-50%) translateY(-30%) scale(1)
            }
        }

        @keyframes gentleSway {
            0% {
                transform: translateX(-50%) translateY(-30%)
            }

            25% {
                transform: translateX(calc(-50% + 0.8px)) translateY(calc(-30% - 0.3px))
            }

            50% {
                transform: translateX(calc(-50% + 0.2px)) translateY(calc(-30% + 0.5px))
            }

            75% {
                transform: translateX(calc(-50% - 0.6px)) translateY(calc(-30% - 0.2px))
            }

            100% {
                transform: translateX(-50%) translateY(-30%)
            }
        }

        @keyframes vitalPulse {
            0%,100% {
                transform: translateX(-50%) translateY(-30%) scale(1)
            }

            20% {
                transform: translateX(-50%) translateY(-30%) scale(1.001)
            }

            50% {
                transform: translateX(-50%) translateY(-30%) scale(1.004)
            }

            80% {
                transform: translateX(-50%) translateY(-30%) scale(1.001)
            }
        }

        @keyframes naturalBreathingRealistic {
            0% {
                transform: translateX(-50%) translateY(-30%) scale(1)
            }

            15% {
                transform: translateX(-50%) translateY(calc(-30% - 0.3px)) scale(1.0008)
            }

            33% {
                transform: translateX(-50%) translateY(calc(-30% - 0.6px)) scale(1.0015)
            }

            40% {
                transform: translateX(-50%) translateY(calc(-30% - 0.6px)) scale(1.0015)
            }

            70% {
                transform: translateX(-50%) translateY(calc(-30% - 0.2px)) scale(1.0005)
            }

            100% {
                transform: translateX(-50%) translateY(-30%) scale(1)
            }
        }

        @keyframes rhythmicBreathing {
            0%,100% {
                transform: translateX(-50%) translateY(-30%) scale(1)
            }

            50% {
                transform: translateX(-50%) translateY(calc(-30% + 1px)) scale(1.002)
            }
        }

        .character-sprite.dynamic[class*=breathing-] {
            pointer-events: auto;
            z-index: inherit;
            will-change: transform;
            backface-visibility: hidden;
            transform-style: preserve-3d
        }

        @media (prefers-reduced-motion:reduce) {
            .character-sprite.dynamic[class*=breathing-] {
                animation-duration: 8s !important;
                animation-timing-function: linear !important
            }

            @keyframes naturalBreathingRealistic {
                0%,100% {
                    transform: translateX(-50%) translateY(-30%) scale(1)
                }

                33% {
                    transform: translateX(-50%) translateY(calc(-30% - 0.15px)) scale(1.0003)
                }

                40% {
                    transform: translateX(-50%) translateY(calc(-30% - 0.15px)) scale(1.0003)
                }
            }
        }

        .character-info-popover {
            min-width: 320px;
            max-width: 400px
        }

        .character-basic-info .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--ui-bg);
            border: 1px solid var(--ui-border-color);
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all .3s ease
        }

        .character-basic-info .info-item:hover {
            background: var(--ui-bg-light);
            border-color: var(--primary-color-light)
        }

        .character-basic-info .info-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-color);
            opacity: .8
        }

        .character-basic-info .info-label i {
            color: var(--primary-color);
            font-size: 14px
        }

        .character-basic-info .info-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color)
        }

        .character-stats-section .stats-container {
            display: flex;
            justify-content: space-around;
            gap: 16px;
            margin-bottom: 16px
        }

        .character-stats-section .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px
        }

        .character-stats-section .stat-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-color);
            opacity: .8
        }

        .circular-progress {
            position: relative;
            width: 80px;
            height: 80px
        }

        .progress-ring {
            transform: rotate(-90deg)
        }

        .progress-ring-circle-bg {
            opacity: .2
        }

        .progress-ring-circle {
            stroke-dasharray: 213.628;
            stroke-dashoffset: 213.628;
            transition: stroke-dashoffset .6s ease;
            stroke-linecap: round
        }

        .progress-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%,-50%);
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color)
        }

        .bar-stat {
            width: 100%;
            padding: 12px;
            background: var(--ui-bg);
            border: 1px solid var(--ui-border-color);
            border-radius: 8px
        }

        .bar-stat .stat-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-color);
            margin-bottom: 8px
        }

        .bar-stat .stat-label i {
            color: var(--primary-color)
        }

        .bar-progress {
            position: relative;
            width: 100%;
            height: 24px;
            background: rgba(120,120,128,.2);
            border-radius: 12px;
            overflow: hidden
        }

        .bar-progress-fill {
            height: 100%;
            background: linear-gradient(90deg,#4CAF50,#8BC34A);
            border-radius: 12px;
            transition: width .6s ease;
            box-shadow: 0 0 10px rgba(76,175,80,.5)
        }

        .bar-progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%,-50%);
            font-size: 12px;
            font-weight: 600;
            color: var(--text-color);
            text-shadow: 0 1px 2px rgba(0,0,0,.3)
        }

        .character-condition-section .condition-container {
            display: flex;
            flex-direction: column;
            gap: 12px
        }

        .character-condition-section .condition-item {
            padding: 12px;
            background: var(--ui-bg);
            border: 1px solid var(--ui-border-color);
            border-radius: 8px
        }

        .character-condition-section .condition-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-color);
            opacity: .8;
            margin-bottom: 8px
        }

        .character-condition-section .condition-label i {
            color: var(--primary-color);
            font-size: 13px
        }

        .character-condition-section .condition-content {
            font-size: 13px;
            color: var(--text-color);
            line-height: 1.5
        }

        .condition-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px
        }

        .status-tag.positive {
            background: linear-gradient(135deg,#4CAF50,#66BB6A);
            color: #fff;
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 500
        }

        .status-tag.negative {
            background: linear-gradient(135deg,#F44336,#EF5350);
            color: #fff;
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 500
        }

        .inventory-list {
            display: flex;
            flex-direction: column;
            gap: 6px
        }

        .inventory-item {
            padding: 8px;
            background: var(--ui-bg-heavy);
            border: 1px solid var(--ui-border-color);
            border-radius: 6px;
            font-size: 12px;
            color: var(--text-color);
            transition: all .3s ease
        }

        .inventory-item:hover {
            background: var(--ui-bg-light);
            border-color: var(--primary-color-light);
            transform: translateX(4px)
        }

        @media (max-width: 480px) {
            .character-info-popover {
                min-width:280px;
                max-width: 350px
            }

            .character-stats-section .stats-container {
                flex-direction: column;
                align-items: center
            }
        }

        .contacts-popover {
            min-width: 650px;
            max-width: 750px;
            padding: 0
        }

        .contacts-layout {
            display: flex;
            height: 550px;
            overflow: hidden
        }

        .contacts-sidebar {
            width: 280px;
            border-right: 1px solid var(--ui-border-color);
            display: flex;
            flex-direction: column;
            background: var(--ui-bg)
        }

        .contacts-header {
            padding: 20px;
            border-bottom: 1px solid var(--ui-border-color)
        }

        .contacts-header label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color)
        }

        .contacts-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px
        }

        .contacts-list::-webkit-scrollbar {
            width: 6px
        }

        .contacts-list::-webkit-scrollbar-track {
            background: rgba(0,0,0,.1);
            border-radius: 3px
        }

        .contacts-list::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px
        }

        .contact-card {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: var(--ui-bg-heavy);
            border: 1px solid var(--ui-border-color);
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all .3s ease;
            position: relative
        }

        .contact-card::before {
            content: "";
            position: absolute;
            left: 0;
            top: 0;
            width: 3px;
            height: 100%;
            background: var(--primary-color);
            border-radius: 10px 0 0 10px;
            opacity: 0;
            transition: opacity .3s ease
        }

        .contact-card:hover,.contact-card.active {
            background: var(--ui-bg-light);
            border-color: var(--primary-color-light);
            transform: translateX(3px)
        }

        .contact-card.active::before {
            opacity: 1
        }

        .contact-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid var(--ui-border-color);
            flex-shrink: 0
        }

        .contact-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover
        }

        .contact-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px
        }

        .contact-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color)
        }

        .contact-relation {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--text-color);
            opacity: .7
        }

        .contact-relation i {
            font-size: 10px;
            color: var(--primary-color)
        }

        .contact-affection {
            display: flex;
            align-items: center;
            gap: 8px
        }

        .affection-bar {
            flex: 1;
            height: 6px;
            background: rgba(120,120,128,.2);
            border-radius: 3px;
            overflow: hidden
        }

        .affection-fill {
            height: 100%;
            background: linear-gradient(90deg,#FF6B6B,#FF8E53);
            border-radius: 3px;
            transition: width .6s ease
        }

        .affection-value {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-color);
            min-width: 32px
        }

        .chat-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--ui-bg-heavy)
        }

        .chat-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--ui-border-color);
            background: var(--ui-bg)
        }

        .chat-contact-info {
            display: flex;
            align-items: center;
            gap: 12px
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid var(--ui-border-color)
        }

        .chat-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover
        }

        .chat-contact-details {
            flex: 1
        }

        .chat-contact-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 2px
        }

        .chat-contact-status {
            font-size: 11px;
            color: var(--text-color);
            opacity: .6
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px
        }

        .chat-messages::-webkit-scrollbar-track {
            background: rgba(0,0,0,.1);
            border-radius: 3px
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px
        }

        .message {
            display: flex;
            gap: 10px;
            align-items: flex-start;
            animation: messageSlideIn .3s ease
        }

        .message.sent {
            flex-direction: row-reverse;
            align-self: flex-end
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid var(--ui-border-color);
            flex-shrink: 0
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover
        }

        .message-content {
            max-width: 70%;
            display: flex;
            flex-direction: column;
            gap: 4px
        }

        .message.sent .message-content {
            align-items: flex-end
        }

        .message-text {
            background: var(--ui-bg);
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 13px;
            color: var(--text-color);
            line-height: 1.5;
            word-wrap: break-word
        }

        .message.sent .message-text {
            background: var(--primary-color);
            color: #fff
        }

        .message-time {
            font-size: 10px;
            color: var(--text-color);
            opacity: .5;
            padding: 0 4px
        }

        .chat-input-area {
            padding: 16px 20px;
            border-top: 1px solid var(--ui-border-color);
            background: var(--ui-bg);
            display: flex;
            gap: 10px;
            align-items: center
        }

        .chat-input {
            flex: 1;
            background: var(--ui-bg-heavy);
            border: 1px solid var(--ui-border-color);
            border-radius: 20px;
            padding: 10px 16px;
            font-size: 13px;
            color: var(--text-color);
            outline: none;
            transition: all .3s ease
        }

        .chat-input:focus {
            border-color: var(--primary-color);
            background: var(--ui-bg-light)
        }

        .chat-send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            border: none;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all .3s ease;
            font-size: 14px
        }

        .chat-send-btn:hover {
            background: var(--primary-color-light);
            transform: scale(1.1)
        }

        .chat-send-btn:active {
            transform: scale(0.95)
        }

        @media (max-width: 768px) {
            .contacts-popover {
                min-width:90vw;
                max-width: 95vw
            }

            .contacts-layout {
                height: 70vh
            }

            .contacts-sidebar {
                width: 200px
            }

            .contact-card {
                flex-direction: column;
                align-items: center;
                text-align: center
            }

            .message-content {
                max-width: 85%
            }
        }

        @media (max-width: 480px) {
            .contacts-sidebar {
                display:none
            }

            .chat-panel {
                width: 100%
            }
        }

        .report-popover {
            min-width: 600px;
            max-width: 700px;
            padding: 0
        }

        .report-container {
            display: flex;
            flex-direction: column;
            height: 600px
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--ui-border-color)
        }

        .report-header label {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color)
        }

        .report-type-switch {
            display: flex;
            gap: 8px;
            background: var(--ui-bg-heavy);
            padding: 4px;
            border-radius: 8px
        }

        .report-type-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: var(--text-color);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all .3s ease
        }

        .report-type-btn:hover {
            background: var(--ui-bg-light)
        }

        .report-type-btn.active {
            background: var(--primary-color);
            color: white
        }

        .report-type-btn i {
            font-size: 14px
        }

        .report-meta {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 12px 20px;
            background: var(--ui-bg-heavy);
            border-bottom: 1px solid var(--ui-border-color)
        }

        .report-date {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-color);
            font-size: 13px
        }

        .report-date i {
            color: var(--primary-color);
            font-size: 14px
        }

        .report-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px
        }

        .report-content::-webkit-scrollbar {
            width: 6px
        }

        .report-content::-webkit-scrollbar-track {
            background: rgba(0,0,0,.1);
            border-radius: 3px
        }

        .report-content::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px
        }

        .report-section {
            margin-bottom: 20px;
            background: var(--ui-bg-heavy);
            border-radius: 10px;
            padding: 16px;
            border: 1px solid var(--ui-border-color)
        }

        .report-section:last-child {
            margin-bottom: 0
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color)
        }

        .section-title i {
            color: var(--primary-color);
            font-size: 14px
        }

        .section-text {
            color: var(--text-color);
            font-size: 13px;
            line-height: 1.8;
            padding-left: 22px
        }

        .report-stats {
            display: flex;
            gap: 12px;
            padding: 16px 20px;
            background: var(--ui-bg-heavy);
            border-top: 1px solid var(--ui-border-color)
        }

        .stat-card {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--ui-bg-light);
            border: 1px solid var(--ui-border-color);
            border-radius: 8px
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary-color);
            border-radius: 8px;
            color: white;
            font-size: 18px
        }

        .stat-info {
            flex: 1
        }

        .stat-label {
            font-size: 11px;
            color: rgba(var(--text-color-rgb),.7);
            margin-bottom: 4px
        }

        .stat-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-color)
        }

        @media (max-width: 768px) {
            .report-popover {
                min-width: 100%;
                max-width: 100%
            }

            .report-container {
                height: 70vh
            }

            .report-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
                padding: 16px
            }

            .report-stats {
                flex-direction: column
            }

            .stat-card {
                width: 100%
            }

            .section-text {
                padding-left: 10px;
                font-size: 12px
            }
        }

        .map-popover {
            min-width: 650px;
            max-width: 750px;
            padding: 0
        }

        .map-container {
            display: flex;
            flex-direction: column;
            height: 600px
        }

        .map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--ui-border-color)
        }

        .map-header label {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color)
        }

        .map-info {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--ui-bg-heavy);
            border-radius: 8px;
            color: var(--text-color);
            font-size: 13px;
            font-weight: 500
        }

        .map-info i {
            color: var(--primary-color);
            font-size: 14px
        }

        .map-viewer {
            flex: 1;
            display: flex;
            align-items: center;
            position: relative;
            overflow: hidden;
            background: var(--ui-bg-heavy)
        }

        .map-nav-btn {
            position: absolute;
            width: 40px;
            height: 40px;
            background: rgba(0,0,0,.5);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all .3s ease;
            z-index: 10;
            backdrop-filter: blur(10px)
        }

        .map-nav-btn:hover {
            background: var(--primary-color);
            transform: scale(1.1)
        }

        .map-nav-btn.map-prev {
            left: 15px
        }

        .map-nav-btn.map-next {
            right: 15px
        }

        .map-display {
            flex: 1;
            height: 100%;
            position: relative;
            overflow: hidden
        }

        .map-image-wrapper {
            display: flex;
            height: 100%;
            transition: transform .5s ease
        }

        .map-slide {
            min-width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            opacity: 0;
            transition: opacity .5s ease
        }

        .map-slide.active {
            opacity: 1
        }

        .map-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: block
        }

        .map-markers {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%
        }

        .map-marker {
            position: absolute;
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 5
        }

        .marker-dot {
            width: 16px;
            height: 16px;
            background: var(--primary-color);
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(0,0,0,.3), 0 0 0 4px rgba(var(--primary-color-rgb),.3);
            transition: all .3s ease;
            animation: pulse 2s infinite
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 10px rgba(0,0,0,.3), 0 0 0 4px rgba(var(--primary-color-rgb),.3)
            }
            50% {
                box-shadow: 0 0 15px rgba(0,0,0,.5), 0 0 0 8px rgba(var(--primary-color-rgb),.5)
            }
        }

        .map-marker:hover .marker-dot {
            transform: scale(1.3);
            background: var(--primary-color-light);
            box-shadow: 0 0 20px rgba(var(--primary-color-rgb),.8), 0 0 0 8px rgba(var(--primary-color-rgb),.5)
        }

        .marker-label {
            position: absolute;
            top: 25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,.85);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: all .3s ease;
            backdrop-filter: blur(10px)
        }

        .marker-label::before {
            content: "";
            position: absolute;
            top: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 5px solid rgba(0,0,0,.85)
        }

        .map-marker:hover .marker-label {
            opacity: 1;
            top: 28px
        }

        .map-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: var(--ui-bg)
        }

        .indicator-dot {
            width: 10px;
            height: 10px;
            background: var(--ui-border-color);
            border-radius: 50%;
            cursor: pointer;
            transition: all .3s ease
        }

        .indicator-dot:hover {
            background: var(--primary-color-light);
            transform: scale(1.2)
        }

        .indicator-dot.active {
            background: var(--primary-color);
            width: 12px;
            height: 12px
        }

        .map-description {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: var(--ui-bg-heavy);
            border-top: 1px solid var(--ui-border-color);
            color: rgba(var(--text-color-rgb),.7);
            font-size: 12px
        }

        .map-description i {
            color: var(--primary-color);
            font-size: 14px
        }

        @media (max-width: 768px) {
            .map-popover {
                min-width: 100%;
                max-width: 100%
            }

            .map-container {
                height: 70vh
            }

            .map-nav-btn {
                width: 35px;
                height: 35px;
                font-size: 16px
            }

            .map-nav-btn.map-prev {
                left: 10px
            }

            .map-nav-btn.map-next {
                right: 10px
            }

            .marker-label {
                font-size: 11px;
                padding: 4px 8px
            }
        }

        .schedule-popover {
            min-width: 420px;
            max-width: 550px
        }

        .schedule-header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%
        }

        .week-navigation {
            display: flex;
            align-items: center;
            gap: 12px
        }

        .week-nav-btn {
            width: 28px;
            height: 28px;
            border: 1px solid var(--ui-border-color);
            background: var(--ui-bg);
            border-radius: 6px;
            color: var(--text-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all .3s ease;
            font-size: 12px
        }

        .week-nav-btn:hover {
            background: var(--primary-color-light);
            border-color: var(--primary-color)
        }

        .week-range {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-color);
            min-width: 60px;
            text-align: center
        }

        .schedule-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 500px;
            overflow-y: auto;
            padding-right: 4px
        }

        .schedule-container::-webkit-scrollbar {
            width: 6px
        }

        .schedule-container::-webkit-scrollbar-track {
            background: rgba(0,0,0,.1);
            border-radius: 3px
        }

        .schedule-container::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px
        }

        .schedule-container::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color-light)
        }

        .day-card {
            background: var(--ui-bg);
            border: 1px solid var(--ui-border-color);
            border-radius: 12px;
            padding: 14px;
            transition: all .3s ease;
            position: relative;
            overflow: visible;
            min-height: 150px
        }

        .day-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary-color);
            opacity: 0;
            transition: opacity .3s ease
        }

        .day-card.weekend::before {
            background: linear-gradient(180deg,#FF6B6B,#FF8E53)
        }

        .day-card:hover {
            background: var(--ui-bg-light);
            border-color: var(--primary-color-light);
            transform: translateX(4px)
        }

        .day-card:hover::before {
            opacity: 1
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--ui-border-color)
        }

        .day-name {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color)
        }

        .day-name i {
            font-size: 8px;
            color: var(--primary-color)
        }

        .day-card.weekend .day-name i {
            color: #FF6B6B
        }

        .day-date {
            font-size: 12px;
            color: var(--text-color);
            opacity: .7;
            font-weight: 500
        }

        .day-events {
            display: flex;
            flex-direction: column;
            gap: 8px
        }

        .event-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: var(--ui-bg-heavy);
            border-radius: 8px;
            transition: all .3s ease;
            min-height: 65px;
            align-items: flex-start
        }

        .event-item:hover {
            background: var(--ui-bg-light);
            transform: translateX(4px)
        }

        .event-time {
            font-size: 11px;
            font-weight: 600;
            color: var(--primary-color);
            min-width: 45px;
            text-align: center;
            padding: 4px 6px;
            background: var(--ui-bg);
            border-radius: 6px;
            border: 1px solid var(--ui-border-color);
            height: fit-content
        }

        .event-content {
            flex: 1
        }

        .event-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 2px
        }

        .event-desc {
            font-size: 11px;
            color: var(--text-color);
            opacity: .7;
            line-height: 1.5;
            word-wrap: break-word;
            white-space: pre-wrap;
            min-height: 20px
        }

        .empty-day {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 20px;
            opacity: .5
        }

        .empty-day i {
            font-size: 24px;
            color: var(--text-color)
        }

        .empty-day span {
            font-size: 12px;
            color: var(--text-color)
        }

        @media (max-width: 480px) {
            .schedule-popover {
                min-width:320px;
                max-width: 380px
            }

            .schedule-container {
                max-height: 400px
            }

            .day-card {
                padding: 10px
            }

            .event-item {
                flex-direction: column;
                gap: 6px
            }

            .event-time {
                width: fit-content
            }
        }

        .quest-popover {
            min-width: 380px;
            max-width: 480px
        }

        .quest-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 500px;
            overflow-y: auto;
            padding-right: 4px
        }

        .quest-container::-webkit-scrollbar {
            width: 6px
        }

        .quest-container::-webkit-scrollbar-track {
            background: rgba(0,0,0,.1);
            border-radius: 3px
        }

        .quest-container::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px
        }

        .quest-container::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color-light)
        }

        .quest-item {
            background: var(--ui-bg);
            border: 1px solid var(--ui-border-color);
            border-radius: 12px;
            padding: 16px;
            transition: all .3s ease;
            position: relative;
            overflow: visible;
            min-height: 140px
        }

        .quest-item::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary-color);
            opacity: 0;
            transition: opacity .3s ease
        }

        .quest-item:hover {
            background: var(--ui-bg-light);
            border-color: var(--primary-color-light);
            transform: translateX(4px)
        }

        .quest-item:hover::before {
            opacity: 1
        }

        .quest-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--ui-border-color)
        }

        .quest-number {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color)
        }

        .quest-number i {
            color: var(--primary-color);
            font-size: 13px
        }

        .quest-status {
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: .5px
        }

        .quest-status.active {
            background: linear-gradient(135deg,#4CAF50,#66BB6A);
            color: #fff
        }

        .quest-status.completed {
            background: linear-gradient(135deg,#2196F3,#42A5F5);
            color: #fff
        }

        .quest-status.pending {
            background: rgba(120,120,128,.2);
            color: var(--text-color);
            opacity: .7
        }

        .quest-content {
            margin-bottom: 10px
        }

        .quest-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-color);
            opacity: .8;
            margin-bottom: 6px
        }

        .quest-title i {
            color: var(--primary-color);
            font-size: 12px
        }

        .quest-description {
            font-size: 13px;
            color: var(--text-color);
            line-height: 1.6;
            padding-left: 20px;
            min-height: 60px;
            max-height: none;
            word-wrap: break-word;
            white-space: pre-wrap
        }

        .quest-reward {
            background: var(--ui-bg-heavy);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px
        }

        .reward-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-color);
            opacity: .8;
            margin-bottom: 8px
        }

        .reward-label i {
            color: var(--gold-color);
            font-size: 12px
        }

        .reward-items {
            display: flex;
            flex-wrap: wrap;
            gap: 8px
        }

        .reward-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--ui-bg);
            border: 1px solid var(--ui-border-color);
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 12px;
            color: var(--text-color);
            transition: all .3s ease
        }

        .reward-item i {
            color: var(--gold-color);
            font-size: 11px
        }

        .reward-item:hover {
            background: var(--ui-bg-light);
            border-color: var(--primary-color-light);
            transform: scale(1.05)
        }

        @media (max-width: 480px) {
            .quest-popover {
                min-width:300px;
                max-width: 360px
            }

            .quest-container {
                max-height: 400px
            }

            .quest-item {
                padding: 12px
            }

            .quest-description {
                padding-left: 0
            }
        }
    </style>

<body data-theme="dark">
    <div id="app-container">
        <main id="content-area">
            <div id="view-novel" class="view-container active">
                <div id="background-overlay" class="background-overlay"></div>
                <div class="character-layer">
                    <div class="character-container">
                        <div class="character-hover-trigger"></div>
                        <img id="character-sprite" class="character-sprite old-sprite" style="display:none!important"/>
                        <div class="character-status-tooltip">
                            <div class="status-tooltip-header">
                                <h3 class="character-fullname" id="character-fullname"></h3>
                                <p class="character-affiliation" id="character-affiliation"></p>
                            </div>
                            <div class="status-tooltip-divider"></div>
                            <div class="status-tooltip-body" id="status-tooltip-body"></div>
                            <div class="status-tooltip-divider"></div>
                            <div class="status-tooltip-footer" id="status-tooltip-footer"></div>
                        </div>
                    </div>
                </div>
                <div class="cg-layer" id="cg-layer">
                    <img id="cg-image" class="cg-image" alt="CG"/>
                </div>
                <div class="ui-layer">
                    <div class="top-header-container">
                        <div class="top-bar">
                            <div class="game-info">
                                <span class="game-date">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span id="current-date"></span>
                                </span>
                                <span class="game-time-period">
                                    <i class="fas fa-clock"></i>
                                    <span id="current-time-period"></span>
                                </span>
                                <span class="game-location">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span id="current-location"></span>
                                </span>
                            </div>
                            <div class="money-display">
                                <span class="money-item" title="é€šç”¨è´§å¸ï¼šé‡Œæ‹‰">
                                    <i class="fas fa-coins"></i>
                                    <span id="player-money"></span>
                                </span>
                            </div>
                        </div>
                        <nav id="main-nav">
                            <button class="nav-btn" id="character-info-btn">
                                <div class="nav-icon">
                                    <i class="fas fa-user"></i>
                                </div>
                                <span class="nav-text">äººç‰©ä¿¡æ¯</span>
                            </button>
                            <button class="nav-btn" id="quest-btn">
                                <div class="nav-icon">
                                    <i class="fas fa-tasks"></i>
                                </div>
                                <span class="nav-text">ä»»åŠ¡</span>
                            </button>
                            <button class="nav-btn" id="schedule-btn">
                                <div class="nav-icon">
                                    <i class="fas fa-calendar-week"></i>
                                </div>
                                <span class="nav-text">æ—¥ç¨‹</span>
                            </button>
                            <button class="nav-btn" id="map-btn">
                                <div class="nav-icon">
                                    <i class="fas fa-map-marked-alt"></i>
                                </div>
                                <span class="nav-text">åœ°å›¾</span>
                            </button>
                            <button class="nav-btn" id="contacts-btn">
                                <div class="nav-icon">
                                    <i class="fas fa-address-book"></i>
                                </div>
                                <span class="nav-text">è”ç³»äºº</span>
                            </button>
                            <button class="nav-btn" id="report-btn">
                                <div class="nav-icon">
                                    <i class="fas fa-file-alt"></i>
                                </div>
                                <span class="nav-text">å‘¨æŠ¥/æ—¥æŠ¥</span>
                            </button>
                            <button class="nav-btn" id="settings-btn">
                                <div class="nav-icon">
                                    <i class="fas fa-cog"></i>
                                </div>
                                <span class="nav-text">è®¾ç½®</span>
                            </button>
                        </nav>
                    </div>
                    <div class="dialogue-box">
                        <div class="character-name" id="speaker-name"></div>
                        <p class="dialogue-text" id="dialogue-content"></p>
                        <div class="dialogue-bottom-controls">
                            <div class="player-choice-input" id="player-choice-input" style="display:none">
                                <div class="choice-input-controls">
                                    <i class="fas fa-comment-dots choice-input-icon"></i>
                                    <input id="choice-text-input" placeholder="è¾“å…¥ä½ æƒ³è¦è¯´çš„è¯æˆ–é‡‡å–çš„è¡ŒåŠ¨..."/>
                                    <button id="add-choice-btn" class="choice-add-btn">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="dialogue-controls">
                                <button class="control-btn" id="prev-btn">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <button class="control-btn" id="next-btn">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <div id="contacts-menu" class="settings-popover contacts-popover">
            <div class="contacts-layout">
                <div class="contacts-sidebar">
                    <div class="contacts-header">
                        <label>è”ç³»äººåˆ—è¡¨</label>
                    </div>
                    <div class="contacts-list">
                        <div class="contact-card active" data-contact-id="1">
                            <div class="contact-avatar">
                                <img src="https://via.placeholder.com/50" alt="è‰¾è‰å¨…">
                            </div>
                            <div class="contact-info">
                                <div class="contact-name">è‰¾è‰å¨…</div>
                                <div class="contact-relation">
                                    <i class="fas fa-heart"></i>
                                    <span>å¯†å‹</span>
                                </div>
                                <div class="contact-affection">
                                    <div class="affection-bar">
                                        <div class="affection-fill" style="width: 85%"></div>
                                    </div>
                                    <span class="affection-value">85%</span>
                                </div>
                            </div>
                        </div>
                        <div class="contact-card" data-contact-id="2">
                            <div class="contact-avatar">
                                <img src="https://via.placeholder.com/50" alt="è±æ˜‚">
                            </div>
                            <div class="contact-info">
                                <div class="contact-name">è±æ˜‚</div>
                                <div class="contact-relation">
                                    <i class="fas fa-shield-alt"></i>
                                    <span>æˆ˜å‹</span>
                                </div>
                                <div class="contact-affection">
                                    <div class="affection-bar">
                                        <div class="affection-fill" style="width: 70%"></div>
                                    </div>
                                    <span class="affection-value">70%</span>
                                </div>
                            </div>
                        </div>
                        <div class="contact-card" data-contact-id="3">
                            <div class="contact-avatar">
                                <img src="https://via.placeholder.com/50" alt="ç´¢è²äºš">
                            </div>
                            <div class="contact-info">
                                <div class="contact-name">ç´¢è²äºš</div>
                                <div class="contact-relation">
                                    <i class="fas fa-book"></i>
                                    <span>å¯¼å¸ˆ</span>
                                </div>
                                <div class="contact-affection">
                                    <div class="affection-bar">
                                        <div class="affection-fill" style="width: 60%"></div>
                                    </div>
                                    <span class="affection-value">60%</span>
                                </div>
                            </div>
                        </div>
                        <div class="contact-card" data-contact-id="4">
                            <div class="contact-avatar">
                                <img src="https://via.placeholder.com/50" alt="å¡å°”">
                            </div>
                            <div class="contact-info">
                                <div class="contact-name">å¡å°”</div>
                                <div class="contact-relation">
                                    <i class="fas fa-store"></i>
                                    <span>å•†äºº</span>
                                </div>
                                <div class="contact-affection">
                                    <div class="affection-bar">
                                        <div class="affection-fill" style="width: 45%"></div>
                                    </div>
                                    <span class="affection-value">45%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="chat-panel">
                    <div class="chat-header">
                        <div class="chat-contact-info">
                            <div class="chat-avatar">
                                <img src="https://via.placeholder.com/40" alt="è‰¾è‰å¨…" id="chat-avatar">
                            </div>
                            <div class="chat-contact-details">
                                <div class="chat-contact-name" id="chat-contact-name">è‰¾è‰å¨…</div>
                                <div class="chat-contact-status" id="chat-contact-status">åœ¨çº¿</div>
                            </div>
                        </div>
                    </div>
                    <div class="chat-messages" id="chat-messages">
                        <div class="message received">
                            <div class="message-avatar">
                                <img src="https://via.placeholder.com/36" alt="è‰¾è‰å¨…">
                            </div>
                            <div class="message-content">
                                <div class="message-text">ä½ å¥½ï¼æœ€è¿‘è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿ</div>
                                <div class="message-time">10:30</div>
                            </div>
                        </div>
                        <div class="message sent">
                            <div class="message-content">
                                <div class="message-text">æŒºå¥½çš„ï¼Œåˆšå®Œæˆäº†ä¸€ä¸ªä»»åŠ¡ã€‚</div>
                                <div class="message-time">10:32</div>
                            </div>
                        </div>
                        <div class="message received">
                            <div class="message-avatar">
                                <img src="https://via.placeholder.com/36" alt="è‰¾è‰å¨…">
                            </div>
                            <div class="message-content">
                                <div class="message-text">å¤ªæ£’äº†ï¼æ™šä¸Šæœ‰ç©ºå—ï¼Ÿä¸€èµ·å»é…’é¦†åº†ç¥ä¸€ä¸‹ï¼Ÿ</div>
                                <div class="message-time">10:33</div>
                            </div>
                        </div>
                        <div class="message sent">
                            <div class="message-content">
                                <div class="message-text">å¥½å•Šï¼Œä»€ä¹ˆæ—¶å€™ï¼Ÿ</div>
                                <div class="message-time">10:35</div>
                            </div>
                        </div>
                        <div class="message received">
                            <div class="message-avatar">
                                <img src="https://via.placeholder.com/36" alt="è‰¾è‰å¨…">
                            </div>
                            <div class="message-content">
                                <div class="message-text">æ™šä¸Š7ç‚¹ï¼Œè€åœ°æ–¹è§ï¼</div>
                                <div class="message-time">10:36</div>
                            </div>
                        </div>
                        <div class="message sent">
                            <div class="message-content">
                                <div class="message-text">æ²¡é—®é¢˜ï¼Œåˆ°æ—¶å€™è§ï¼</div>
                                <div class="message-time">10:37</div>
                            </div>
                        </div>
                        <div class="message received">
                            <div class="message-avatar">
                                <img src="https://via.placeholder.com/36" alt="è‰¾è‰å¨…">
                            </div>
                            <div class="message-content">
                                <div class="message-text">å¥½çš„ï¼Œå›è§~</div>
                                <div class="message-time">10:38</div>
                            </div>
                        </div>
                    </div>
                    <div class="chat-input-area">
                        <input type="text" class="chat-input" placeholder="è¾“å…¥æ¶ˆæ¯..." id="chat-input">
                        <button class="chat-send-btn" id="chat-send-btn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div id="schedule-menu" class="settings-popover schedule-popover">
            <div class="settings-section">
                <div class="schedule-header-container">
                    <label>æœ¬å‘¨æ—¥ç¨‹</label>
                    <div class="week-navigation">
                        <button class="week-nav-btn" id="prev-week">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span class="week-range" id="week-range">ç¬¬ 1 å‘¨</span>
                        <button class="week-nav-btn" id="next-week">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="schedule-container">
                <div class="day-card" data-day="monday">
                    <div class="day-header">
                        <div class="day-name">
                            <i class="fas fa-circle"></i>
                            å‘¨ä¸€
                        </div>
                        <div class="day-date" data-date="1æœˆ1æ—¥">1æœˆ1æ—¥</div>
                    </div>
                    <div class="day-events">
                        <div class="event-item">
                            <div class="event-time">09:00</div>
                            <div class="event-content">
                                <div class="event-title">æ™¨ä¼š</div>
                                <div class="event-desc">è®¨è®ºæœ¬å‘¨å·¥ä½œè®¡åˆ’</div>
                            </div>
                        </div>
                        <div class="event-item">
                            <div class="event-time">14:00</div>
                            <div class="event-content">
                                <div class="event-title">è®­ç»ƒ</div>
                                <div class="event-desc">æ­¦å™¨è®­ç»ƒåœºé›†åˆ</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="day-card" data-day="tuesday">
                    <div class="day-header">
                        <div class="day-name">
                            <i class="fas fa-circle"></i>
                            å‘¨äºŒ
                        </div>
                        <div class="day-date" data-date="1æœˆ2æ—¥">1æœˆ2æ—¥</div>
                    </div>
                    <div class="day-events">
                        <div class="event-item">
                            <div class="event-time">10:00</div>
                            <div class="event-content">
                                <div class="event-title">å·¡é€»</div>
                                <div class="event-desc">åŸåŒ—åŒºåŸŸä¾‹è¡Œå·¡é€»</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="day-card" data-day="wednesday">
                    <div class="day-header">
                        <div class="day-name">
                            <i class="fas fa-circle"></i>
                            å‘¨ä¸‰
                        </div>
                        <div class="day-date" data-date="1æœˆ3æ—¥">1æœˆ3æ—¥</div>
                    </div>
                    <div class="day-events">
                        <div class="event-item">
                            <div class="event-time">å…¨å¤©</div>
                            <div class="event-content">
                                <div class="event-title">ä¼‘æ¯æ—¥</div>
                                <div class="event-desc">è‡ªç”±æ´»åŠ¨</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="day-card" data-day="thursday">
                    <div class="day-header">
                        <div class="day-name">
                            <i class="fas fa-circle"></i>
                            å‘¨å››
                        </div>
                        <div class="day-date" data-date="1æœˆ4æ—¥">1æœˆ4æ—¥</div>
                    </div>
                    <div class="day-events">
                        <div class="event-item">
                            <div class="event-time">08:00</div>
                            <div class="event-content">
                                <div class="event-title">å‡ºå‹¤</div>
                                <div class="event-desc">å‰å¾€ä¸œéƒ¨å“¨æ‰€å€¼å‹¤</div>
                            </div>
                        </div>
                        <div class="event-item">
                            <div class="event-time">18:00</div>
                            <div class="event-content">
                                <div class="event-title">æ™šå®´</div>
                                <div class="event-desc">å…¬ä¼šèšé¤</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="day-card" data-day="friday">
                    <div class="day-header">
                        <div class="day-name">
                            <i class="fas fa-circle"></i>
                            å‘¨äº”
                        </div>
                        <div class="day-date" data-date="1æœˆ5æ—¥">1æœˆ5æ—¥</div>
                    </div>
                    <div class="day-events">
                        <div class="event-item">
                            <div class="event-time">15:00</div>
                            <div class="event-content">
                                <div class="event-title">ä¼šè®®</div>
                                <div class="event-desc">æœˆåº¦æ€»ç»“ä¼šè®®</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="day-card weekend" data-day="saturday">
                    <div class="day-header">
                        <div class="day-name">
                            <i class="fas fa-circle"></i>
                            å‘¨å…­
                        </div>
                        <div class="day-date" data-date="1æœˆ6æ—¥">1æœˆ6æ—¥</div>
                    </div>
                    <div class="day-events">
                        <div class="event-item">
                            <div class="event-time">å…¨å¤©</div>
                            <div class="event-content">
                                <div class="event-title">ä¼‘æ¯</div>
                                <div class="event-desc">å‘¨æœ«ä¼‘æ¯</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="day-card weekend" data-day="sunday">
                    <div class="day-header">
                        <div class="day-name">
                            <i class="fas fa-circle"></i>
                            å‘¨æ—¥
                        </div>
                        <div class="day-date" data-date="1æœˆ7æ—¥">1æœˆ7æ—¥</div>
                    </div>
                    <div class="day-events">
                        <div class="empty-day">
                            <i class="fas fa-sun"></i>
                            <span>æš‚æ— å®‰æ’</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="quest-menu" class="settings-popover quest-popover">
            <div class="settings-section">
                <label>ä»»åŠ¡åˆ—è¡¨</label>
            </div>
            <div class="quest-container">
                <div class="quest-item">
                    <div class="quest-header">
                        <div class="quest-number">
                            <i class="fas fa-bookmark"></i>
                            <span>ä»»åŠ¡ #001</span>
                        </div>
                        <div class="quest-status active">è¿›è¡Œä¸­</div>
                    </div>
                    <div class="quest-content">
                        <div class="quest-title">
                            <i class="fas fa-scroll"></i>
                            ä»»åŠ¡å†…å®¹
                        </div>
                        <div class="quest-description">
                            æ¢ç´¢ç¥ç§˜çš„å¤ä»£é—è¿¹ï¼Œå¯»æ‰¾å¤±è½çš„æ–‡æ˜ç—•è¿¹ã€‚å®Œæˆè¿™ä¸ªä»»åŠ¡å°†è·å¾—ä¸°åšçš„å¥–åŠ±ã€‚
                        </div>
                    </div>
                    <div class="quest-reward">
                        <div class="reward-label">
                            <i class="fas fa-gift"></i>
                            ä»»åŠ¡å¥–åŠ±
                        </div>
                        <div class="reward-items">
                            <span class="reward-item">
                                <i class="fas fa-coins"></i>
                                500 é‡‘å¸
                            </span>
                            <span class="reward-item">
                                <i class="fas fa-star"></i>
                                100 ç»éªŒ
                            </span>
                        </div>
                    </div>
                </div>
                <div class="quest-item">
                    <div class="quest-header">
                        <div class="quest-number">
                            <i class="fas fa-bookmark"></i>
                            <span>ä»»åŠ¡ #002</span>
                        </div>
                        <div class="quest-status completed">å·²å®Œæˆ</div>
                    </div>
                    <div class="quest-content">
                        <div class="quest-title">
                            <i class="fas fa-scroll"></i>
                            ä»»åŠ¡å†…å®¹
                        </div>
                        <div class="quest-description">
                            æ”¶é›†10ä¸ªé­”æ³•æ°´æ™¶ï¼Œç”¨äºä¿®å¤é­”æ³•é˜µã€‚
                        </div>
                    </div>
                    <div class="quest-reward">
                        <div class="reward-label">
                            <i class="fas fa-gift"></i>
                            ä»»åŠ¡å¥–åŠ±
                        </div>
                        <div class="reward-items">
                            <span class="reward-item">
                                <i class="fas fa-coins"></i>
                                300 é‡‘å¸
                            </span>
                        </div>
                    </div>
                </div>
                <div class="quest-item">
                    <div class="quest-header">
                        <div class="quest-number">
                            <i class="fas fa-bookmark"></i>
                            <span>ä»»åŠ¡ #003</span>
                        </div>
                        <div class="quest-status pending">æœªæ¥å–</div>
                    </div>
                    <div class="quest-content">
                        <div class="quest-title">
                            <i class="fas fa-scroll"></i>
                            ä»»åŠ¡å†…å®¹
                        </div>
                        <div class="quest-description">
                            å‰å¾€æš—å½±æ£®æ—ï¼Œè°ƒæŸ¥æœ€è¿‘å‘ç”Ÿçš„å¼‚å¸¸ç°è±¡ã€‚
                        </div>
                    </div>
                    <div class="quest-reward">
                        <div class="reward-label">
                            <i class="fas fa-gift"></i>
                            ä»»åŠ¡å¥–åŠ±
                        </div>
                        <div class="reward-items">
                            <span class="reward-item">
                                <i class="fas fa-coins"></i>
                                800 é‡‘å¸
                            </span>
                            <span class="reward-item">
                                <i class="fas fa-star"></i>
                                200 ç»éªŒ
                            </span>
                            <span class="reward-item">
                                <i class="fas fa-gem"></i>
                                ç¥ç§˜å®çŸ³
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="character-info-menu" class="settings-popover character-info-popover">
            <div class="settings-section">
                <label>äººç‰©ä¿¡æ¯</label>
            </div>
            <div class="settings-section character-basic-info">
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-id-card"></i>
                        å§“å
                    </div>
                    <div class="info-value" id="char-name">æœªè®¾ç½®</div>
                </div>
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-crown"></i>
                        èº«ä»½
                    </div>
                    <div class="info-value" id="char-identity">æœªè®¾ç½®</div>
                </div>
            </div>
            <div class="settings-section character-stats-section">
                <div class="section-header">
                    <i class="fas fa-chart-line"></i>
                    <label class="section-title">å±æ€§çŠ¶æ€</label>
                </div>
                <div class="stats-container">
                    <div class="stat-item circular-stat">
                        <div class="stat-label">æˆ˜åŠ›ç­‰çº§</div>
                        <div class="circular-progress" data-stat="power">
                            <svg class="progress-ring" width="80" height="80">
                                <circle class="progress-ring-circle-bg" stroke="#e0e0e0" stroke-width="6" fill="transparent" r="34" cx="40" cy="40"/>
                                <circle class="progress-ring-circle" stroke="url(#gradient-power)" stroke-width="6" fill="transparent" r="34" cx="40" cy="40"/>
                                <defs>
                                    <linearGradient id="gradient-power" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#FF6B6B;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#FF8E53;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                            </svg>
                            <div class="progress-value" id="power-value">0%</div>
                        </div>
                    </div>
                    <div class="stat-item circular-stat">
                        <div class="stat-label">æ¸´æ±‚åº¦</div>
                        <div class="circular-progress" data-stat="desire">
                            <svg class="progress-ring" width="80" height="80">
                                <circle class="progress-ring-circle-bg" stroke="#e0e0e0" stroke-width="6" fill="transparent" r="34" cx="40" cy="40"/>
                                <circle class="progress-ring-circle" stroke="url(#gradient-desire)" stroke-width="6" fill="transparent" r="34" cx="40" cy="40"/>
                                <defs>
                                    <linearGradient id="gradient-desire" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#A78BFA;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#C084FC;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                            </svg>
                            <div class="progress-value" id="desire-value">0%</div>
                        </div>
                    </div>
                </div>
                <div class="stat-item bar-stat">
                    <div class="stat-label">
                        <i class="fas fa-bolt"></i>
                        èƒ½é‡æ§½
                    </div>
                    <div class="bar-progress">
                        <div class="bar-progress-fill" id="energy-bar" style="width: 0%"></div>
                        <div class="bar-progress-text" id="energy-value">0%</div>
                    </div>
                </div>
            </div>
            <div class="settings-section character-condition-section">
                <div class="section-header">
                    <i class="fas fa-heartbeat"></i>
                    <label class="section-title">èº«ä½“çŠ¶å†µ</label>
                </div>
                <div class="condition-container">
                    <div class="condition-item">
                        <div class="condition-label">
                            <i class="fas fa-file-medical"></i>
                            èº«ä½“æè¿°
                        </div>
                        <div class="condition-content" id="body-description">æš‚æ— æè¿°</div>
                    </div>
                    <div class="condition-item">
                        <div class="condition-label">
                            <i class="fas fa-plus-circle"></i>
                            æ­£é¢çŠ¶æ€
                        </div>
                        <div class="condition-tags" id="positive-status">
                            <span class="status-tag positive">å¥åº·</span>
                        </div>
                    </div>
                    <div class="condition-item">
                        <div class="condition-label">
                            <i class="fas fa-minus-circle"></i>
                            è´Ÿé¢çŠ¶æ€
                        </div>
                        <div class="condition-tags" id="negative-status">
                            <span class="status-tag negative">æ— </span>
                        </div>
                    </div>
                    <div class="condition-item">
                        <div class="condition-label">
                            <i class="fas fa-briefcase"></i>
                            èƒŒåŒ…
                        </div>
                        <div class="condition-content inventory-list" id="inventory">
                            <div class="inventory-item">ç©ºèƒŒåŒ…</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="settings-menu" class="settings-popover">
            <div class="settings-section">
                <label>ä¸»é¢˜åˆ‡æ¢</label>
                <div class="theme-buttons-container">
                    <button data-theme="light" class="theme-btn" title="æµ…è‰²ä¸»é¢˜">
                        <i class="fas fa-sun"></i>
                    </button>
                    <button data-theme="dark" class="theme-btn active" title="æ·±è‰²ä¸»é¢˜">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button data-theme="glass" class="theme-btn" title="æ¯›ç»ç’ƒ">
                        <i class="fas fa-layer-group"></i>
                    </button>
                </div>
            </div>
            <div class="settings-section visual-effects-section">
                <div class="section-header">
                    <i class="fas fa-magic"></i>
                    <label class="section-title">è§†è§‰éŸ³æ•ˆ</label>
                </div>
                <div class="settings-options">
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-name">
                                <i class="fas fa-lungs"></i>
                                è§’è‰²å‘¼å¸æ•ˆæœ
                            </div>
                            <div class="setting-description">ä¸ºè§’è‰²ç«‹ç»˜æ·»åŠ å¾®å¦™çš„å‘¼å¸åŠ¨ç”»æ•ˆæœ</div>
                        </div>
                        <div class="setting-control">
                            <label class="modern-toggle">
                                <input type="checkbox" id="breathing-toggle" checked="checked">
                                <div class="toggle-track">
                                    <div class="toggle-thumb">
                                        <i class="toggle-icon fas fa-check"></i>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-name">
                                <i class="fas fa-keyboard"></i>
                                é”®ç›˜å¿«æ·é”®
                            </div>
                            <div class="setting-description">ç©ºæ ¼/æ–¹å‘é”®æ¨è¿›å¯¹è¯</div>
                        </div>
                        <div class="setting-control">
                            <label class="modern-toggle">
                                <input type="checkbox" id="keyboard-shortcuts-toggle">
                                <div class="toggle-track">
                                    <div class="toggle-thumb">
                                        <i class="toggle-icon fas fa-check"></i>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-name">
                                <i class="fas fa-expand"></i>
                                åŒå‡»å…¨å±
                            </div>
                            <div class="setting-description">åŒå‡»ç©ºç™½åŒºåŸŸè¿›å…¥å…¨å±æ¨¡å¼</div>
                        </div>
                        <div class="setting-control">
                            <label class="modern-toggle">
                                <input type="checkbox" id="fullscreen-toggle">
                                <div class="toggle-track">
                                    <div class="toggle-thumb">
                                        <i class="toggle-icon fas fa-check"></i>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-name">
                                <i class="fas fa-volume-up"></i>
                                èƒŒæ™¯éŸ³ä¹
                            </div>
                            <div class="setting-description">æ§åˆ¶æ¸¸æˆèƒŒæ™¯éŸ³ä¹çš„æ’­æ”¾</div>
                        </div>
                        <div class="setting-control">
                            <label class="modern-toggle">
                                <input type="checkbox" id="bgm-toggle" checked="checked">
                                <div class="toggle-track">
                                    <div class="toggle-thumb">
                                        <i class="toggle-icon fas fa-check"></i>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="settings-section text-settings-section">
                <div class="section-header">
                    <i class="fas fa-font"></i>
                    <label class="section-title">æ–‡å­—è®¾ç½®</label>
                </div>
                <div class="settings-options">
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-name">
                                <i class="fas fa-keyboard"></i>
                                æ–‡å­—æ˜¾ç¤ºæ•ˆæœ
                            </div>
                            <div class="setting-description">é€‰æ‹©æ–‡å­—å‡ºç°çš„åŠ¨ç”»æ•ˆæœ</div>
                        </div>
                        <div class="setting-control">
                            <select id="text-animation-type" class="modern-select">
                                <option value="typewriter">æ‰“å­—æœºæ•ˆæœ</option>
                                <option value="fade">æ¸æ˜¾æ•ˆæœ</option>
                                <option value="instant">å³æ—¶æ˜¾ç¤º</option>
                            </select>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-name">
                                <i class="fas fa-tachometer-alt"></i>
                                æ–‡å­—é€Ÿåº¦
                            </div>
                            <div class="setting-description">è°ƒæ•´æ–‡å­—å‡ºç°çš„é€Ÿåº¦</div>
                        </div>
                        <div class="setting-control">
                            <div class="slider-container">
                                <input type="range" id="text-speed-slider" class="modern-slider" min="10" max="200" value="180" step="10">
                                <div class="slider-labels">
                                    <span>æ…¢</span>
                                    <span id="text-speed-value">30ms</span>
                                    <span>å¿«</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-name">
                                <i class="fas fa-text-height"></i>
                                å­—ä½“å¤§å°
                            </div>
                            <div class="setting-description">è°ƒæ•´å¯¹è¯æ–‡å­—çš„å¤§å°</div>
                        </div>
                        <div class="setting-control">
                            <div class="slider-container">
                                <input type="range" id="font-size-slider" class="modern-slider" min="12" max="32" value="16" step="2">
                                <div class="slider-labels">
                                    <span>å°</span>
                                    <span id="font-size-value">16px</span>
                                    <span>å¤§</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="settings-section default-settings-section">
                <div class="settings-options">
                    <div class="setting-item reset-setting-item">
                        <div class="setting-control">
                            <button id="reset-settings-btn" class="reset-btn">æ¢å¤é»˜è®¤</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="report-menu" class="settings-popover report-popover">
            <div class="report-container">
                <div class="report-header">
                    <label>å‘¨æŠ¥/æ—¥æŠ¥</label>
                    <div class="report-type-switch">
                        <button class="report-type-btn active" data-type="daily">
                            <i class="fas fa-calendar-day"></i>
                            æ—¥æŠ¥
                        </button>
                        <button class="report-type-btn" data-type="weekly">
                            <i class="fas fa-calendar-week"></i>
                            å‘¨æŠ¥
                        </button>
                    </div>
                </div>
                <div class="report-meta">
                    <div class="report-date">
                        <i class="fas fa-calendar"></i>
                        <span id="report-date">2024å¹´1æœˆ1æ—¥</span>
                    </div>
                </div>
                <div class="report-content">
                    <div class="report-section">
                        <div class="section-title">
                            <i class="fas fa-bullseye"></i>
                            ä»Šæ—¥ç›®æ ‡
                        </div>
                        <div class="section-text">
                            1. å®Œæˆç¥ç§˜é—è¿¹æ¢ç´¢ä»»åŠ¡<br>
                            2. æå‡æˆ˜æ–—æŠ€èƒ½ç­‰çº§<br>
                            3. æ”¶é›†ç¨€æœ‰ææ–™
                        </div>
                    </div>
                    <div class="report-section">
                        <div class="section-title">
                            <i class="fas fa-check-circle"></i>
                            å®Œæˆæƒ…å†µ
                        </div>
                        <div class="section-text">
                            âœ“ æˆåŠŸæ¢ç´¢äº†å¤ä»£é—è¿¹ç¬¬ä¸€å±‚<br>
                            âœ“ è·å¾—äº†ä¼ è¯´çº§æ­¦å™¨<br>
                            âœ“ å®Œæˆäº†å…¬ä¼šæ—¥å¸¸ä»»åŠ¡<br>
                            âœ“ å¸®åŠ©æ‘æ°‘è§£å†³äº†é­”ç‰©å›°æ‰°
                        </div>
                    </div>
                    <div class="report-section">
                        <div class="section-title">
                            <i class="fas fa-exclamation-triangle"></i>
                            é‡åˆ°çš„é—®é¢˜
                        </div>
                        <div class="section-text">
                            â€¢ é—è¿¹ç¬¬äºŒå±‚çš„è°œé¢˜æ¯”è¾ƒå¤æ‚ï¼Œéœ€è¦æ›´å¤šæ—¶é—´ç ”ç©¶<br>
                            â€¢ é˜Ÿå‹é…åˆéœ€è¦åŠ å¼º<br>
                            â€¢ æŸäº›æŠ€èƒ½å†·å´æ—¶é—´è¿‡é•¿
                        </div>
                    </div>
                    <div class="report-section">
                        <div class="section-title">
                            <i class="fas fa-lightbulb"></i>
                            ä¸‹ä¸€æ­¥è®¡åˆ’
                        </div>
                        <div class="section-text">
                            1. ç»„ç»‡å›¢é˜Ÿæ”»ç•¥é—è¿¹ç¬¬äºŒå±‚<br>
                            2. å­¦ä¹ æ–°çš„æˆ˜æ–—æŠ€èƒ½<br>
                            3. æ”¶é›†æ›´å¤šè£…å¤‡å¼ºåŒ–ææ–™<br>
                            4. å‚åŠ ä¸‹å‘¨çš„å…¬ä¼šæ´»åŠ¨
                        </div>
                    </div>
                </div>
                <div class="report-stats">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-label">å®Œæˆä»»åŠ¡</div>
                            <div class="stat-value">5/8</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-label">æ´»åŠ¨æ—¶é•¿</div>
                            <div class="stat-value">6.5h</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-label">è·å¾—ç»éªŒ</div>
                            <div class="stat-value">2850</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="map-menu" class="settings-popover map-popover">
            <div class="map-container">
                <div class="map-header">
                    <label>åœ°å›¾å¯¼èˆª</label>
                    <div class="map-info">
                        <i class="fas fa-map"></i>
                        <span id="current-map-name">ä¸­å¤®åŸåŒº</span>
                    </div>
                </div>
                <div class="map-viewer">
                    <button class="map-nav-btn map-prev" id="map-prev-btn">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="map-display">
                        <div class="map-image-wrapper" id="map-image-wrapper">
                            <!-- åœ°å›¾1: ä¸­å¤®åŸåŒº -->
                            <div class="map-slide active" data-map-id="1" data-map-name="ä¸­å¤®åŸåŒº">
                                <img src="https://via.placeholder.com/600x400/4a90e2/ffffff?text=ä¸­å¤®åŸåŒºåœ°å›¾" alt="ä¸­å¤®åŸåŒº" class="map-image">
                                <!-- å›¾ç‰‡URLå¡«å†™ä½ç½®ï¼šä¿®æ”¹ä¸Šæ–¹srcå±æ€§ -->
                                <div class="map-markers">
                                    <div class="map-marker" data-location="å†’é™©è€…å…¬ä¼š" style="top: 30%; left: 25%">
                                        <div class="marker-dot"></div>
                                        <div class="marker-label">å†’é™©è€…å…¬ä¼š</div>
                                    </div>
                                    <div class="map-marker" data-location="ä¸­å¤®å¹¿åœº" style="top: 45%; left: 50%">
                                        <div class="marker-dot"></div>
                                        <div class="marker-label">ä¸­å¤®å¹¿åœº</div>
                                    </div>
                                    <div class="map-marker" data-location="å•†ä¸šè¡—" style="top: 60%; left: 70%">
                                        <div class="marker-dot"></div>
                                        <div class="marker-label">å•†ä¸šè¡—</div>
                                    </div>
                                    <div class="map-marker" data-location="å›¾ä¹¦é¦†" style="top: 25%; left: 75%">
                                        <div class="marker-dot"></div>
                                        <div class="marker-label">å›¾ä¹¦é¦†</div>
                                    </div>
                                </div>
                            </div>
                            <!-- åœ°å›¾2: éƒŠå¤–æ£®æ— -->
                            <div class="map-slide" data-map-id="2" data-map-name="éƒŠå¤–æ£®æ—">
                                <img src="https://via.placeholder.com/600x400/5cb85c/ffffff?text=éƒŠå¤–æ£®æ—åœ°å›¾" alt="éƒŠå¤–æ£®æ—" class="map-image">
                                <!-- å›¾ç‰‡URLå¡«å†™ä½ç½®ï¼šä¿®æ”¹ä¸Šæ–¹srcå±æ€§ -->
                                <div class="map-markers">
                                    <div class="map-marker" data-location="æ£®æ—å…¥å£" style="top: 70%; left: 20%">
                                        <div class="marker-dot"></div>
                                        <div class="marker-label">æ£®æ—å…¥å£</div>
                                    </div>
                                    <div class="map-marker" data-location="ç²¾çµæ ‘å±‹" style="top: 35%; left: 40%">
                                        <div class="marker-dot"></div>
                                        <div class="marker-label">ç²¾çµæ ‘å±‹</div>
                                    </div>
                                    <div class="map-marker" data-location="ç¥ç§˜æ¹–æ³Š" style="top: 50%; left: 65%">
                                        <div class="marker-dot"></div>
                                        <div class="marker-label">ç¥ç§˜æ¹–æ³Š</div>
                                    </div>
                                    <div class="map-marker" data-location="å¤è€ç¥æ®¿" style="top: 20%; left: 80%">
                                        <div class="marker-dot"></div>
                                        <div class="marker-label">å¤è€ç¥æ®¿</div>
                                    </div>
                                    <div class="map-marker" data-location="é‡è¥åœ°" style="top: 55%; left: 30%">
                                        <div class="marker-dot"></div>
                                        <div class="marker-label">é‡è¥åœ°</div>
                                    </div>
                                </div>
                            </div>
                            <!-- åœ°å›¾3: è¿œå¤é—è¿¹ -->
                            <div class="map-slide" data-map-id="3" data-map-name="è¿œå¤é—è¿¹">
                                <img src="https://via.placeholder.com/600x400/f0ad4e/ffffff?text=è¿œå¤é—è¿¹åœ°å›¾" alt="è¿œå¤é—è¿¹" class="map-image">
                                <!-- å›¾ç‰‡URLå¡«å†™ä½ç½®ï¼šä¿®æ”¹ä¸Šæ–¹srcå±æ€§ -->
                                <div class="map-markers">
                                    <div class="map-marker" data-location="é—è¿¹å¤§é—¨" style="top: 65%; left: 50%">
                                        <div class="marker-dot"></div>
                                        <div class="marker-label">é—è¿¹å¤§é—¨</div>
                                    </div>
                                    <div class="map-marker" data-location="ç¬¬ä¸€å±‚" style="top: 50%; left: 35%">
                                        <div class="marker-dot"></div>
                                        <div class="marker-label">ç¬¬ä¸€å±‚</div>
                                    </div>
                                    <div class="map-marker" data-location="ç¬¬äºŒå±‚" style="top: 35%; left: 50%">
                                        <div class="marker-dot"></div>
                                        <div class="marker-label">ç¬¬äºŒå±‚</div>
                                    </div>
                                    <div class="map-marker" data-location="å®è—å®¤" style="top: 40%; left: 70%">
                                        <div class="marker-dot"></div>
                                        <div class="marker-label">å®è—å®¤</div>
                                    </div>
                                    <div class="map-marker" data-location="Bossæˆ¿é—´" style="top: 20%; left: 50%">
                                        <div class="marker-dot"></div>
                                        <div class="marker-label">Bossæˆ¿é—´</div>
                                    </div>
                                    <div class="map-marker" data-location="å¯†é“" style="top: 30%; left: 25%">
                                        <div class="marker-dot"></div>
                                        <div class="marker-label">å¯†é“</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="map-nav-btn map-next" id="map-next-btn">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="map-indicator">
                    <span class="indicator-dot active" data-slide="0"></span>
                    <span class="indicator-dot" data-slide="1"></span>
                    <span class="indicator-dot" data-slide="2"></span>
                </div>
                <div class="map-description">
                    <i class="fas fa-info-circle"></i>
                    <span>ç‚¹å‡»åœ°å›¾ä¸Šçš„æ ‡è®°ç‚¹å¿«é€Ÿå‰å¾€è¯¥ä½ç½®</span>
                </div>
            </div>
        </div>
    </div>
</body>
